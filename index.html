<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yashraj English High School - Complete Management System</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --primary-light: #818cf8;
            --secondary: #0f172a;
            --accent: #f59e0b;
            --accent-dark: #d97706;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #06b6d4;
            --light: #f8fafc;
            --dark: #1e293b;
            --gray: #64748b;
            --gray-light: #f1f5f9;
            --gradient-primary: linear-gradient(135deg, var(--primary), #7c3aed);
            --gradient-secondary: linear-gradient(135deg, var(--secondary), #334155);
            --gradient-accent: linear-gradient(135deg, var(--accent), #fbbf24);
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            color: var(--dark);
            background-color: #ffffff;
            line-height: 1.6;
            overflow-x: hidden;
            font-weight: 400;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            line-height: 1.2;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        /* Swiper Slider Styles */
        .school-slider {
            margin-top: 76px; /* Account for fixed navbar */
            height: 70vh;
            position: relative;
            overflow: hidden;
        }
        
        .swiper {
            width: 100%;
            height: 100%;
        }
        
        .swiper-slide {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .swiper-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .slide-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 30px;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
            color: white;
            z-index: 2;
        }
        
        .slide-category {
            display: inline-block;
            background: var(--gradient-primary);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .slide-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .slide-description {
            font-size: 1rem;
            opacity: 0.9;
            max-width: 600px;
        }
        
        .swiper-button-next, .swiper-button-prev {
            color: white;
            background: rgba(0, 0, 0, 0.3);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-top: -25px;
        }
        
        .swiper-button-next:after, .swiper-button-prev:after {
            font-size: 1.2rem;
        }
        
        .swiper-pagination-bullet {
            width: 12px;
            height: 12px;
            background: white;
            opacity: 0.5;
        }
        
        .swiper-pagination-bullet-active {
            opacity: 1;
            background: var(--primary);
        }
        
        /* Navbar Styles */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-sm);
            padding: 1rem 0;
            transition: var(--transition);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }
        
        .navbar.scrolled {
            padding: 0.75rem 0;
            box-shadow: var(--shadow-lg);
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.75rem;
            color: var(--primary) !important;
            display: flex;
            align-items: center;
        }
        
        .navbar-brand i {
            background: var(--gradient-primary);
            color: white;
            padding: 10px;
            border-radius: 50%;
            margin-right: 12px;
            font-size: 1.5rem;
        }
        
        .navbar-nav .nav-link {
            color: var(--dark) !important;
            font-weight: 500;
            margin: 0 8px;
            transition: var(--transition);
            position: relative;
            padding: 8px 12px;
            border-radius: var(--radius-md);
        }
        
        .navbar-nav .nav-link:hover {
            color: var(--primary) !important;
            background: rgba(79, 70, 229, 0.05);
        }
        
        .navbar-nav .nav-link.active {
            color: var(--primary) !important;
            background: rgba(79, 70, 229, 0.1);
        }
        
        .navbar-nav .nav-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gradient-primary);
            transition: var(--transition);
            border-radius: 2px;
        }
        
        .navbar-nav .nav-link:hover::after,
        .navbar-nav .nav-link.active::after {
            width: 80%;
        }
        
        /* Hero Section */
        .hero-section {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.9) 0%, rgba(124, 58, 237, 0.9) 100%), 
                        url('https://images.unsplash.com/photo-1523050854058-8df90110c9f1?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: white;
            padding: 120px 0 100px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
            opacity: 0.5;
        }
        
        .hero-content {
            position: relative;
            z-index: 2;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .hero-section h1 {
            font-size: 3.5rem;
            margin-bottom: 1.5rem;
            font-weight: 700;
            animation: fadeInUp 1s ease;
        }
        
        .hero-section p {
            font-size: 1.25rem;
            margin: 0 auto 2.5rem;
            opacity: 0.9;
            animation: fadeInUp 1s ease 0.2s both;
        }
        
        .hero-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            animation: fadeInUp 1s ease 0.4s both;
        }
        
        /* Rest of your existing CSS styles remain unchanged */
        /* Section Styles */
        .section-padding {
            padding: 100px 0;
        }
        
        .section-title {
            text-align: center;
            margin-bottom: 3rem;
            position: relative;
        }
        
        .section-title h2 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--secondary);
        }
        
        .section-title p {
            font-size: 1.125rem;
            color: var(--gray);
            max-width: 600px;
            margin: 0 auto;
        }
        
        .section-title::after {
            content: '';
            position: absolute;
            width: 80px;
            height: 4px;
            background: var(--gradient-primary);
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 2px;
        }
        
        /* Card Styles */
        .card {
            border: none;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
            margin-bottom: 30px;
            border-radius: var(--radius-lg);
            overflow: hidden;
            background: white;
        }
        
        .card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-xl);
        }
        
        .card-header {
            background: white;
            border-bottom: 1px solid #f1f5f9;
            padding: 1.5rem;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .card-footer {
            background: white;
            border-top: 1px solid #f1f5f9;
            padding: 1rem 1.5rem;
        }
        
        /* Faculty Section */
        .faculty-card {
            text-align: center;
            padding: 2rem 1.5rem;
            border-radius: var(--radius-lg);
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }
        
        .faculty-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient-primary);
        }
        
        .faculty-img {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid white;
            margin: 0 auto 1.5rem;
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
        }
        
        .faculty-card:hover .faculty-img {
            transform: scale(1.05);
        }
        
        /* Toppers Slider */
        .toppers-slider {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 80px 0;
            overflow: hidden;
            position: relative;
        }
        
        .toppers-slider::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%234f46e5' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        
        .topper-slide {
            display: flex;
            animation: slide 30s linear infinite;
        }
        
        .topper-item {
            flex: 0 0 auto;
            width: 240px;
            margin: 0 15px;
            text-align: center;
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
        }
        
        .topper-item:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .topper-img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 1rem;
            border: 3px solid var(--primary);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        @keyframes slide {
            0% {
                transform: translateX(0);
            }
            100% {
                transform: translateX(-100%);
            }
        }
        
        /* Events Section */
        .event-card {
            border-left: 4px solid var(--primary);
            transition: var(--transition);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        
        .event-card:hover {
            border-left-color: var(--accent);
            transform: translateX(5px);
        }
        
        .event-date {
            background: var(--gradient-primary);
            color: white;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            text-align: center;
            display: inline-block;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-sm);
        }
        
        .event-date .day {
            font-size: 1.5rem;
            font-weight: 700;
            display: block;
            line-height: 1;
        }
        
        .event-date .month {
            font-size: 0.875rem;
            text-transform: uppercase;
            opacity: 0.9;
        }
        
        /* Modal Styles */
        .modal-content {
            border-radius: var(--radius-xl);
            border: none;
            box-shadow: var(--shadow-xl);
            overflow: hidden;
        }
        
        .modal-header {
            background: var(--gradient-primary);
            color: white;
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            padding: 1.5rem;
        }
        
        .btn {
            font-weight: 500;
            border-radius: var(--radius-md);
            transition: var(--transition);
            padding: 0.75rem 1.5rem;
        }
        
        .btn-primary {
            background: var(--gradient-primary);
            border: none;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.25);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(79, 70, 229, 0.35);
        }
        
        .btn-outline-primary {
            border: 2px solid var(--primary);
            color: var(--primary);
            background: transparent;
        }
        
        .btn-outline-primary:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.25);
        }
        
        /* Stats Cards */
        .stats-card {
            background: var(--gradient-primary);
            color: white;
            border-radius: var(--radius-lg);
            padding: 2rem;
            text-align: center;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            position: relative;
        }
        
        .stats-label {
            font-size: 0.9rem;
            opacity: 0.9;
            position: relative;
        }
        
        /* Profile Pages */
        .profile-container {
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            padding: 2rem;
            margin-top: 2rem;
        }
        
        .profile-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--primary);
            margin: 0 auto 1rem;
            box-shadow: var(--shadow-md);
        }
        
        /* Table Styles */
        .table-responsive {
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        
        .table thead {
            background: var(--gradient-primary);
            color: white;
        }
        
        /* Footer */
        .footer {
            background: var(--secondary);
            color: white;
            padding: 80px 0 40px;
            position: relative;
        }
        
        .footer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient-primary);
        }
        
        .footer h5 {
            margin-bottom: 1.5rem;
            position: relative;
            padding-bottom: 0.75rem;
            font-weight: 600;
        }
        
        .footer h5::after {
            content: '';
            position: absolute;
            width: 40px;
            height: 2px;
            background: var(--primary);
            bottom: 0;
            left: 0;
        }
        
        .footer-links li {
            margin-bottom: 0.75rem;
        }
        
        .footer-links a {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: var(--transition);
            display: flex;
            align-items: center;
        }
        
        .footer-links a i {
            margin-right: 0.75rem;
            width: 20px;
            font-size: 0.875rem;
        }
        
        .footer-links a:hover {
            color: white;
            padding-left: 5px;
        }
        
        .copyright {
            text-align: center;
            padding-top: 2rem;
            margin-top: 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.875rem;
        }
        
        /* Dashboard Styles */
        .dashboard-nav {
            background: white;
            box-shadow: var(--shadow-md);
            padding: 1rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        }
        
        .dashboard-content {
            min-height: 500px;
        }
        
        /* Badge Styles */
        .badge {
            font-weight: 500;
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-sm);
        }
        
        .badge-caste-general { background-color: var(--info); }
        .badge-caste-obc { background-color: var(--success); }
        .badge-caste-sc { background-color: var(--warning); color: #212529; }
        .badge-caste-st { background-color: var(--danger); }
        
        /* File Upload Styles */
        .file-upload-container {
            border: 2px dashed #e2e8f0;
            border-radius: var(--radius-lg);
            padding: 3rem 2rem;
            text-align: center;
            margin: 1.5rem 0;
            transition: var(--transition);
            background: #f8fafc;
        }
        
        .file-upload-container:hover {
            border-color: var(--primary);
            background: rgba(79, 70, 229, 0.05);
        }
        
        .file-upload-container.dragover {
            border-color: var(--primary);
            background-color: rgba(79, 70, 229, 0.1);
        }
        
        /* Cloudinary Upload Progress */
        .upload-progress {
            margin-top: 15px;
            display: none;
        }
        
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            background-color: #e2e8f0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .upload-status {
            font-size: 0.875rem;
            margin-top: 5px;
            color: var(--gray);
        }
        
        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Floating Elements */
        .floating {
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
            100% {
                transform: translateY(0px);
            }
        }
        
        /* Glass Effect */
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Text Gradient */
        .text-gradient {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Attendance System Styles */
        .attendance-header {
            display: grid;
            grid-template-columns: 60px 80px 1fr 150px 120px;
            gap: 15px;
            padding: 18px 25px;
            background-color: var(--light);
            font-weight: 600;
            border-bottom: 2px solid #e1e5e9;
            position: sticky;
            top: 0;
            z-index: 10;
            color: var(--dark);
        }
        
        .attendance-row {
            display: grid;
            grid-template-columns: 60px 80px 1fr 150px 120px;
            gap: 15px;
            padding: 18px 25px;
            border-bottom: 1px solid #f0f0f0;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .attendance-row:last-child {
            border-bottom: none;
        }
        
        .attendance-row:hover {
            background-color: #f8fafc;
        }
        
        .status-badge {
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            width: 100px;
        }
        
        .status-present {
            background-color: #e6f4ea;
            color: #137333;
            border: 1px solid #34a853;
        }
        
        .status-absent {
            background-color: #fce8e6;
            color: #a50e0e;
            border: 1px solid #ea4335;
        }
        
        .status-late {
            background-color: #fef7e0;
            color: #b06000;
            border: 1px solid #fbbc05;
        }
        
        .status-left-early {
            background-color: #feefe6;
            color: #b34700;
            border: 1px solid #fd7e14;
        }
        
        .status-select {
            width: 100%;
            padding: 8px 12px;
            border-radius: 6px;
            border: 2px solid #e1e5e9;
            background-color: white;
            font-size: 14px;
            cursor: pointer;
        }
        
        .attendance-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .attendance-stat-card {
            background-color: var(--light);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s;
            border-left: 4px solid;
        }
        
        .attendance-stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        
        .attendance-stat-present {
            border-left-color: var(--success);
        }
        
        .attendance-stat-absent {
            border-left-color: var(--danger);
        }
        
        .attendance-stat-late {
            border-left-color: var(--warning);
        }
        
        .attendance-stat-left-early {
            border-left-color: #fd7e14;
        }
        
        .attendance-stat-value {
            font-size: 36px;
            font-weight: 700;
            margin: 12px 0;
        }
        
        .attendance-stat-present .attendance-stat-value {
            color: var(--success);
        }
        
        .attendance-stat-absent .attendance-stat-value {
            color: var(--danger);
        }
        
        .attendance-stat-late .attendance-stat-value {
            color: var(--warning);
        }
        
        .attendance-stat-left-early .attendance-stat-value {
            color: #fd7e14;
        }
        
        .attendance-actions {
            display: flex;
            gap: 12px;
            margin-top: 10px;
        }
        
        .attendance-actions button {
            flex: 1;
            padding: 10px;
        }
        
        .btn-present {
            background-color: var(--success);
        }
        
        .btn-present:hover {
            background-color: #2e8b47;
        }
        
        .btn-absent {
            background-color: var(--danger);
        }
        
        .btn-absent:hover {
            background-color: #d32f2f;
        }
        
        .btn-late {
            background-color: var(--warning);
            color: #212529;
        }
        
        .btn-late:hover {
            background-color: #e6ac00;
        }
        
        .btn-left-early {
            background-color: #fd7e14;
        }
        
        .btn-left-early:hover {
            background-color: #e56a00;
        }
        
        .notification {
            position: fixed;
            top: 25px;
            right: 25px;
            padding: 18px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .notification.success {
            background-color: var(--success);
        }
        
        .notification.error {
            background-color: var(--danger);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            .hero-section h1 {
                font-size: 2.75rem;
            }
            
            .section-padding {
                padding: 80px 0;
            }
            
            .school-slider {
                height: 50vh;
            }
            
            .slide-title {
                font-size: 1.5rem;
            }
        }
        
        @media (max-width: 768px) {
            .hero-section {
                padding: 140px 0 80px;
                background-attachment: scroll;
            }
            
            .hero-section h1 {
                font-size: 2.25rem;
            }
            
            .hero-section p {
                font-size: 1.125rem;
            }
            
            .hero-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .section-title h2 {
                font-size: 2rem;
            }
            
            .navbar-brand {
                font-size: 1.5rem;
            }
            
            .attendance-header, .attendance-row {
                grid-template-columns: 40px 1fr 1fr;
                gap: 8px;
            }
            
            .attendance-header div:nth-child(4),
            .attendance-row div:nth-child(4),
            .attendance-header div:nth-child(5),
            .attendance-row div:nth-child(5) {
                display: none;
            }
            
            .school-slider {
                height: 40vh;
            }
            
            .slide-content {
                padding: 20px;
            }
            
            .slide-title {
                font-size: 1.3rem;
            }
            
            .slide-description {
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 576px) {
            .hero-section h1 {
                font-size: 2rem;
            }
            
            .section-padding {
                padding: 60px 0;
            }
            
            .school-slider {
                height: 35vh;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-graduation-cap"></i>Yashraj English High School
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#home">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#about">About</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#events">Events</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#loginModal">Login</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#admissionModal">Admission</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- School Image Slider -->
    <section class="school-slider">
        <div class="swiper mySwiper">
            <div class="swiper-wrapper">
                <!-- Slide 1: School Building -->
                <div class="swiper-slide">
                    <img src="https://images.unsplash.com/photo-1560250097-0b93528c311a?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80" alt="Yashraj English High School Building">
                    <div class="slide-content">
                        <span class="slide-category">School Infrastructure</span>
                        <h2 class="slide-title">Our Modern School Building</h2>
                        <p class="slide-description">Experience our state-of-the-art campus with modern classrooms, science labs, and sports facilities designed to provide the best learning environment.</p>
                    </div>
                </div>
                
                <!-- Slide 2: Teachers -->
                <div class="swiper-slide">
                    <img src="https://images.unsplash.com/photo-1560250097-0b93528c311a?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80" alt="Our Dedicated Teaching Staff">
                    <div class="slide-content">
                        <span class="slide-category">Teaching Staff</span>
                        <h2 class="slide-title">Meet Our Expert Faculty</h2>
                        <p class="slide-description">Our highly qualified and experienced teachers are committed to nurturing young minds and shaping future leaders through innovative teaching methods.</p>
                    </div>
                </div>
                
                <!-- Slide 3: Toppers -->
                <div class="swiper-slide">
                    <img src="https://images.unsplash.com/photo-1560250097-0b93528c311a?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80" alt="Our Academic Achievers">
                    <div class="slide-content">
                        <span class="slide-category">Academic Excellence</span>
                        <h2 class="slide-title">Celebrating Our Achievers</h2>
                        <p class="slide-description">Proudly showcasing our top-performing students who have excelled in academics and brought laurels to our institution.</p>
                    </div>
                </div>
                
                <!-- Slide 4: Admission -->
                <div class="swiper-slide">
                    <img src="https://yashrajenglishhighschool.in/images/admission.jpg" alt="Admissions Open">
                    <div class="slide-content">
                        <span class="slide-category">Admissions</span>
                        <h2 class="slide-title">Admissions Open 2025-26</h2>
                        <p class="slide-description">Enroll now for classes 1st to 12th. Limited seats available. Join our community of learners and achievers.</p>
                    </div>
                </div>
                
                <!-- Slide 5: Events -->
                <div class="swiper-slide">
                    <img src="https://yashrajenglishhighschool.in/images/events.jpg" alt="School Events">
                    <div class="slide-content">
                        <span class="slide-category">Events & Activities</span>
                        <h2 class="slide-title">Celebrating School Events</h2>
                        <p class="slide-description">From annual day celebrations to sports events, we provide a platform for students to showcase their talents beyond academics.</p>
                    </div>
                </div>
            </div>
            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
            <div class="swiper-pagination"></div>
        </div>
    </section>

    <!-- Home Section -->
    <section id="home" class="hero-section">
        <div class="container">
            <div class="hero-content">
                <h1>Empowering Future Leaders Through Excellence</h1>
                <p>Yashraj English High School provides a transformative educational experience that balances academic rigor with holistic development, preparing students for success in a rapidly changing world.</p>
                <div class="hero-buttons">
                    <a href="#" class="btn btn-light btn-lg me-2" data-bs-toggle="modal" data-bs-target="#admissionModal">Admission Open 2025-26</a>
                    <a href="#about" class="btn btn-outline-light btn-lg">Learn More</a>
                </div>
            </div>
        </div>
    </section>

    <!-- About Section -->
    <section id="about" class="section-padding">
        <div class="container">
            <div class="section-title">
                <h2>Excellence in Education Since 1995</h2>
                <p>With over 25 years of educational excellence, we've shaped thousands of young minds to become responsible global citizens.</p>
            </div>
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="card h-100">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-primary bg-opacity-10 p-3 rounded-circle me-3">
                                    <i class="fas fa-eye text-primary fa-lg"></i>
                                </div>
                                <h3 class="card-title mb-0">Our Vision</h3>
                            </div>
                            <p class="card-text">To create a nurturing environment that fosters academic excellence, character development, and lifelong learning. We aim to empower students to become responsible global citizens who contribute positively to society.</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="card h-100">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-primary bg-opacity-10 p-3 rounded-circle me-3">
                                    <i class="fas fa-bullseye text-primary fa-lg"></i>
                                </div>
                                <h3 class="card-title mb-0">Our Mission</h3>
                            </div>
                            <p class="card-text">To provide a comprehensive education that balances academic rigor with co-curricular activities. We focus on developing critical thinking, creativity, and ethical values in our students through innovative teaching methodologies.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-5">
                <div class="col-12">
                    <h3 class="text-center mb-4">Meet Our Leadership Team</h3>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card faculty-card">
                        <img src="https://images.unsplash.com/photo-1560250097-0b93528c311a?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80" alt="Head Of Academy" class="faculty-img">
                        <h4>Mr. Parshuram Yadav</h4>
                        <p class="text-muted">Head of Academy</p>
                        <p>Mr. Parshuram Yadav brings innovative educational strategies and a student-centric approach to our academy.</p>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card faculty-card">
                        <img src="https://image2url.com/images/1759169830194-ed0790f0-558c-40d1-87a2-11c34ad98f88.jpg" alt="Principal" class="faculty-img">
                        <h4>Mr. Fayaz Sir</h4>
                        <p class="text-muted">Principal</p>
                        <p>With over 20 years of experience in education, Mr. Fayaz Sir leads our institution with vision and dedication.</p>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card faculty-card">
                        <img src="https://images.unsplash.com/photo-1573496359142-b8d87734a5a2?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80" alt="Vise Principal" class="faculty-img">
                        <h4>Mrs. Priyanka Ma'am</h4>
                        <p class="text-muted">Vice Principal</p>
                        <p>Mr. Priyanka Ma'am ensures smooth academic operations and student welfare with his administrative expertise.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Toppers Slider -->
    <section class="toppers-slider">
        <div class="container">
            <div class="section-title">
                <h2>Our Academic Achievers</h2>
                <p>Celebrating the exceptional achievements of our students in board examinations</p>
            </div>
            <div class="topper-slide">
                <!-- Topper items will be dynamically added here -->
            </div>
        </div>
    </section>

    <!-- Events Section -->
    <section id="events" class="section-padding bg-light">
        <div class="container">
            <div class="section-title">
                <h2>Upcoming Events</h2>
                <p>Stay updated with our school activities, events, and important dates</p>
            </div>
            <div class="row" id="eventsContainer">
                <!-- Events will be dynamically loaded here -->
            </div>
        </div>
    </section>

    <!-- Admission Section -->
    <section id="admission" class="section-padding">
        <div class="container">
            <div class="section-title">
                <h2>Admission Process</h2>
                <p>Join our community of learners and achievers</p>
            </div>
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h3 class="card-title mb-0">Admission Criteria</h3>
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-3"></i>
                                    Admission open for classes 1st to 12th
                                </li>
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-3"></i>
                                    Age criteria as per education board norms
                                </li>
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-3"></i>
                                    Previous academic records considered
                                </li>
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-3"></i>
                                    Interaction with student and parents
                                </li>
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-3"></i>
                                    Seats allocated on first-come, first-served basis
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h3 class="card-title mb-0">Required Documents</h3>
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-file-alt text-primary me-3"></i>
                                    Birth Certificate
                                </li>
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-id-card text-primary me-3"></i>
                                    Aadhaar Card of student
                                </li>
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-certificate text-primary me-3"></i>
                                    Previous school leaving certificate
                                </li>
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-image text-primary me-3"></i>
                                    Passport size photographs (4 copies)
                                </li>
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-home text-primary me-3"></i>
                                    Address proof
                                </li>
                                <li class="list-group-item d-flex align-items-center">
                                    <i class="fas fa-file-certificate text-primary me-3"></i>
                                    Caste certificate (if applicable)
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center mt-4">
                <a href="#" class="btn btn-primary btn-lg px-5" data-bs-toggle="modal" data-bs-target="#admissionModal">Apply for Admission</a>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 col-md-6 mb-4">
                    <h5>About Us</h5>
                    <p>Yashraj English High School is committed to providing quality education with a focus on holistic development of students.</p>
                    <div class="social-links mt-4">
                        <a href="#" class="text-white me-3"><i class="fab fa-facebook-f fa-lg"></i></a>
                        <a href="#" class="text-white me-3"><i class="fab fa-twitter fa-lg"></i></a>
                        <a href="#" class="text-white me-3"><i class="fab fa-instagram fa-lg"></i></a>
                        <a href="#" class="text-white"><i class="fab fa-linkedin-in fa-lg"></i></a>
                    </div>
                </div>
                <div class="col-lg-2 col-md-6 mb-4">
                    <h5>Quick Links</h5>
                    <ul class="list-unstyled footer-links">
                        <li><a href="#home"><i class="fas fa-chevron-right"></i>Home</a></li>
                        <li><a href="#about"><i class="fas fa-chevron-right"></i>About</a></li>
                        <li><a href="#events"><i class="fas fa-chevron-right"></i>Events</a></li>
                        <li><a href="#" data-bs-toggle="modal" data-bs-target="#admissionModal"><i class="fas fa-chevron-right"></i>Admission</a></li>
                        <li><a href="#"><i class="fas fa-chevron-right"></i>Academics</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <h5>Contact Info</h5>
                    <ul class="list-unstyled footer-links">
                        <li><a href="#"><i class="fas fa-map-marker-alt"></i> 123 Education Street, Mumbai, India</a></li>
                        <li><a href="tel:+919876543210"><i class="fas fa-phone"></i> +91 98765 43210</a></li>
                        <li><a href="mailto:info@yashrajenglishhighschool.in"><i class="fas fa-envelope"></i> info@yashrajenglishhighschool.in</a></li>
                        <li><a href="#"><i class="fas fa-clock"></i> Mon - Fri: 8:00 AM - 4:00 PM</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <h5>Newsletter</h5>
                    <p>Subscribe to our newsletter for updates on events and important announcements.</p>
                    <form id="newsletterForm">
                        <div class="input-group mb-3">
                            <input type="email" class="form-control" placeholder="Your Email" required>
                            <button class="btn btn-primary" type="submit">Subscribe</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="copyright">
                <p>Made with care — Yash Raj School Portal • For any help, contact support@yashrajenglishhighschool.live</p>
            </div>
        </div>
    </footer>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel">Login to Your Account</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="roleSelection">
                        <p class="text-center mb-4">Select your role to continue</p>
                        <div class="d-grid gap-3">
                            <button class="btn btn-outline-primary role-btn" data-role="student">
                                <i class="fas fa-user-graduate me-2"></i>Student Login
                            </button>
                            <button class="btn btn-outline-primary role-btn" data-role="teacher">
                                <i class="fas fa-chalkboard-teacher me-2"></i>Teacher Login
                            </button>
                            <button class="btn btn-outline-primary role-btn" data-role="principal">
                                <i class="fas fa-user-tie me-2"></i>Principal Login
                            </button>
                        </div>
                    </div>
                    
                    <div id="loginForm" style="display: none;">
                        <form id="actualLoginForm">
                            <div id="standardField" class="mb-3" style="display: none;">
                                <label for="standard" class="form-label">Standard</label>
                                <select class="form-select" id="standard">
                                    <option value="" selected disabled>Select your standard</option>
                                    <option value="1">1st Standard</option>
                                    <option value="2">2nd Standard</option>
                                    <option value="3">3rd Standard</option>
                                    <option value="4">4th Standard</option>
                                    <option value="5">5th Standard</option>
                                    <option value="6">6th Standard</option>
                                    <option value="7">7th Standard</option>
                                    <option value="8">8th Standard</option>
                                    <option value="9">9th Standard</option>
                                    <option value="10">10th Standard</option>
                                    <option value="11">11th Standard</option>
                                    <option value="12">12th Standard</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="loginEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="loginEmail" required>
                            </div>
                            <div class="mb-3">
                                <label for="loginPassword" class="form-label">Password</label>
                                <input type="password" class="form-control" id="loginPassword" required>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">Login</button>
                            </div>
                        </form>
                        <div class="text-center mt-3">
                            <a href="#" id="backToRole">Back to role selection</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admission Modal -->
    <div class="modal fade" id="admissionModal" tabindex="-1" aria-labelledby="admissionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="admissionModalLabel">Admission Application Form</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="admissionForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="studentName" class="form-label">Student Full Name</label>
                                <input type="text" class="form-control" id="studentName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="dob" class="form-label">Date of Birth</label>
                                <input type="date" class="form-control" id="dob" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="gender" class="form-label">Gender</label>
                                <select class="form-select" id="gender" required>
                                    <option value="" selected disabled>Select Gender</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="applyingFor" class="form-label">Applying for Class</label>
                                <select class="form-select" id="applyingFor" required>
                                    <option value="" selected disabled>Select Class</option>
                                    <option value="1">1st Standard</option>
                                    <option value="2">2nd Standard</option>
                                    <option value="3">3rd Standard</option>
                                    <option value="4">4th Standard</option>
                                    <option value="5">5th Standard</option>
                                    <option value="6">6th Standard</option>
                                    <option value="7">7th Standard</option>
                                    <option value="8">8th Standard</option>
                                    <option value="9">9th Standard</option>
                                    <option value="10">10th Standard</option>
                                    <option value="11">11th Standard</option>
                                    <option value="12">12th Standard</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="previousSchool" class="form-label">Previous School (if any)</label>
                            <input type="text" class="form-control" id="previousSchool">
                        </div>
                        
                        <div class="mb-3">
                            <label for="casteCategory" class="form-label">Caste Category</label>
                            <select class="form-select" id="casteCategory" required>
                                <option value="" selected disabled>Select Caste Category</option>
                                <option value="general">General</option>
                                <option value="obc">OBC</option>
                                <option value="sc">SC</option>
                                <option value="st">ST</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="entranceMarks" class="form-label">Entrance Test Marks (out of 100)</label>
                            <input type="number" class="form-control" id="entranceMarks" min="0" max="100" required>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="parentName" class="form-label">Parent/Guardian Name</label>
                                <input type="text" class="form-control" id="parentName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="parentOccupation" class="form-label">Parent/Guardian Occupation</label>
                                <input type="text" class="form-control" id="parentOccupation">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="phone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="phone" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">Email Address</label>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="address" class="form-label">Full Address</label>
                            <textarea class="form-control" id="address" rows="3" required></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                                <label class="form-check-label" for="agreeTerms">
                                    I agree to the terms and conditions of Yashraj English High School
                                </label>
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Submit Application</button>
                        </div>
                    </form>
                </div>
            </div>
        </div> 
    </div>

    <!-- Dashboard Modal -->
    <div class="modal fade" id="dashboardModal" tabindex="-1" aria-labelledby="dashboardModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dashboardModalLabel">Dashboard</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="dashboardContent">
                        <!-- Dashboard content will be loaded here based on user role -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance Modal -->
    <div class="modal fade" id="attendanceModal" tabindex="-1" aria-labelledby="attendanceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="attendanceModalLabel">Take Attendance</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="attendance-controls mb-4">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="attendanceDate" class="form-label">Date</label>
                                <input type="date" class="form-control" id="attendanceDate">
                            </div>
                            <div class="col-md-4">
                                <label for="attendanceClass" class="form-label">Class</label>
                                <select class="form-select" id="attendanceClass">
                                    <option value="">-- Select Class --</option>
                                </select>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <div class="attendance-actions">
                                    <button class="btn btn-present" id="markAllPresent"><i class="fas fa-check-circle"></i> Mark All Present</button>
                                    <button class="btn btn-absent" id="markAllAbsent"><i class="fas fa-times-circle"></i> Mark All Absent</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="loading" id="attendanceLoading">
                        <div class="loading-spinner"></div>
                        <p>Loading students...</p>
                    </div>
                    
                    <div class="attendance-summary" id="attendanceSummary" style="display: none;">
                        <div class="attendance-stat-card attendance-stat-present">
                            <div>Present</div>
                            <div class="attendance-stat-value" id="presentCount">0</div>
                            <div>students</div>
                        </div>
                        <div class="attendance-stat-card attendance-stat-absent">
                            <div>Absent</div>
                            <div class="attendance-stat-value" id="absentCount">0</div>
                            <div>students</div>
                        </div>
                        <div class="attendance-stat-card attendance-stat-late">
                            <div>Late</div>
                            <div class="attendance-stat-value" id="lateCount">0</div>
                            <div>students</div>
                        </div>
                        <div class="attendance-stat-card attendance-stat-left-early">
                            <div>Left Early</div>
                            <div class="attendance-stat-value" id="leftEarlyCount">0</div>
                            <div>students</div>
                        </div>
                    </div>
                    
                    <div class="attendance-list" id="attendanceList" style="display: none;">
                        <div class="attendance-header">
                            <div>#</div>
                            <div>Roll No</div>
                            <div>Student Name</div>
                            <div>Status</div>
                            <div>Actions</div>
                        </div>
                        <div id="attendanceStudentsContainer">
                            <!-- Students will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="mt-4" id="attendanceActions" style="display: none;">
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-primary" id="saveAttendance"><i class="fas fa-save"></i> Save Attendance</button>
                            <button class="btn btn-outline-secondary" id="closeAttendance">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Upload Modal -->
    <div class="modal fade" id="imageUploadModal" tabindex="-1" aria-labelledby="imageUploadModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageUploadModalLabel">Upload Profile Photo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="file-upload-container" id="fileUploadContainer">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                        <p>Drag & drop your photo here or click to browse</p>
                        <input type="file" id="profilePhotoInput" accept="image/*" style="display: none;">
                        <button type="button" class="btn btn-outline-primary mt-2" onclick="document.getElementById('profilePhotoInput').click()">Select Photo</button>
                    </div>
                    <div id="imagePreview" class="text-center mt-3" style="display: none;">
                        <img id="previewImage" src="" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                    </div>
                    <!-- Cloudinary Upload Progress -->
                    <div class="upload-progress" id="uploadProgress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="upload-status" id="uploadStatus">Uploading...</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="uploadPhotoBtn">Upload Photo</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal (Updated with Password Fields) -->
    <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="mb-3">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="newUserName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="newUserEmail" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role</label>
                            <select class="form-select" id="newUserRole" required>
                                <option value="" selected disabled>Select Role</option>
                                <option value="student">Student</option>
                                <option value="teacher">Teacher</option>
                                <option value="principal">Principal</option>
                            </select>
                        </div>
                        <div class="mb-3" id="newUserStandardField" style="display: none;">
                            <label class="form-label">Standard</label>
                            <select class="form-select" id="newUserStandard">
                                <option value="" selected disabled>Select Standard</option>
                                <option value="1">1st Standard</option>
                                <option value="2">2nd Standard</option>
                                <option value="3">3rd Standard</option>
                                <option value="4">4th Standard</option>
                                <option value="5">5th Standard</option>
                                <option value="6">6th Standard</option>
                                <option value="7">7th Standard</option>
                                <option value="8">8th Standard</option>
                                <option value="9">9th Standard</option>
                                <option value="10">10th Standard</option>
                                <option value="11">11th Standard</option>
                                <option value="12">12th Standard</option>
                            </select>
                        </div>
                        <!-- NEW: Password Fields -->
                        <div class="mb-3">
                            <label class="form-label">Set Password</label>
                            <input type="password" class="form-control" id="newUserPassword" required minlength="6">
                            <div class="form-text">Password must be at least 6 characters long</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Confirm Password</label>
                            <input type="password" class="form-control" id="newUserConfirmPassword" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addNewUser()">Add User</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Student Details Modal for Principal -->
    <div class="modal fade" id="studentDetailsModal" tabindex="-1" aria-labelledby="studentDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="studentDetailsModalLabel">Student Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="principalClassSelect" class="form-label">Select Class</label>
                        <select class="form-select" id="principalClassSelect">
                            <option value="">-- Select Class --</option>
                            <option value="1">1st Standard</option>
                            <option value="2">2nd Standard</option>
                            <option value="3">3rd Standard</option>
                            <option value="4">4th Standard</option>
                            <option value="5">5th Standard</option>
                            <option value="6">6th Standard</option>
                            <option value="7">7th Standard</option>
                            <option value="8">8th Standard</option>
                            <option value="9">9th Standard</option>
                            <option value="10">10th Standard</option>
                            <option value="11">11th Standard</option>
                            <option value="12">12th Standard</option>
                        </select>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Roll No</th>
                                    <th>Name</th>
                                    <th>Caste</th>
                                    <th>Attendance (Days)</th>
                                    <th>Percentage</th>
                                    <th>Fees Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="principalStudentsTable">
                                <!-- Students will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Fees Dashboard Modal -->
    <div class="modal fade" id="feesDashboardModal" tabindex="-1" aria-labelledby="feesDashboardModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="feesDashboardModalLabel">Fees Management</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="feesClassSelect" class="form-label">Select Class</label>
                        <select class="form-select" id="feesClassSelect">
                            <option value="">-- Select Class --</option>
                            <option value="1">1st Standard</option>
                            <option value="2">2nd Standard</option>
                            <option value="3">3rd Standard</option>
                            <option value="4">4th Standard</option>
                            <option value="5">5th Standard</option>
                            <option value="6">6th Standard</option>
                            <option value="7">7th Standard</option>
                            <option value="8">8th Standard</option>
                            <option value="9">9th Standard</option>
                            <option value="10">10th Standard</option>
                            <option value="11">11th Standard</option>
                            <option value="12">12th Standard</option>
                        </select>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Roll No</th>
                                    <th>Name</th>
                                    <th>Total Fees</th>
                                    <th>Paid Fees</th>
                                    <th>Due Fees</th>
                                    <th>Last Payment Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="feesStudentsTable">
                                <!-- Students will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Update Fees Modal -->
    <div class="modal fade" id="updateFeesModal" tabindex="-1" aria-labelledby="updateFeesModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateFeesModalLabel">Update Fees</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="updateFeesForm">
                        <input type="hidden" id="updateFeesStudentId">
                        <div class="mb-3">
                            <label class="form-label">Student Name</label>
                            <input type="text" class="form-control" id="updateFeesStudentName" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Total Fees (₹)</label>
                            <input type="number" class="form-control" id="updateFeesTotal" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Paid Fees (₹)</label>
                            <input type="number" class="form-control" id="updateFeesPaid" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Payment Date</label>
                            <input type="date" class="form-control" id="updateFeesDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveFeesUpdate()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Attendance History Modal -->
    <div class="modal fade" id="attendanceHistoryModal" tabindex="-1" aria-labelledby="attendanceHistoryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="attendanceHistoryModalLabel">Attendance History</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label for="historyClassSelect" class="form-label">Class</label>
                            <select class="form-select" id="historyClassSelect">
                                <option value="">-- Select Class --</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="historyDateFrom" class="form-label">From Date</label>
                            <input type="date" class="form-control" id="historyDateFrom">
                        </div>
                        <div class="col-md-4">
                            <label for="historyDateTo" class="form-label">To Date</label>
                            <input type="date" class="form-control" id="historyDateTo">
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Class</th>
                                    <th>Present</th>
                                    <th>Absent</th>
                                    <th>Late</th>
                                    <th>Left Early</th>
                                    <th>Marked By</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceHistoryTable">
                                <!-- Attendance history will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Swiper JS -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut, 
            updatePassword,
            onAuthStateChanged,
            reauthenticateWithCredential,
            EmailAuthProvider
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            doc, 
            getDoc, 
            setDoc, 
            deleteDoc, 
            query, 
            orderBy, 
            where, 
            updateDoc, 
            writeBatch,
            limit,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
        import { 
            getDatabase, 
            ref, 
            set, 
            get, 
            child, 
            push,
            onValue
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAW5bnjnNsUXTJM032PzfPhQ8F60g9yp2g",
            authDomain: "techinfowithpawan.firebaseapp.com",
            projectId: "techinfowithpawan",
            storageBucket: "techinfowithpawan.firebasestorage.app",
            messagingSenderId: "790651883822",
            appId: "1:790651883822:web:6bf0c3814121436acaeabf",
            measurementId: "G-3D8TVP86GF",
            databaseURL: "https://techinfowithpawan-default-rtdb.firebaseio.com/"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const realtimeDb = getDatabase(app); // NEW: Realtime Database

        // Cloudinary Configuration
        const cloudinaryConfig = {
            cloudName: 'dnk4krmnq',
            uploadPreset: 'school_profile_photos'
        };

        // Global variables
        let currentUser = null;
        let currentUserData = null;
        let selectedFile = null;
        let attendanceStudents = [];

        // Toppers data
        const toppers = [
            { name: "Rahul Sharma", percentage: "92.2%", image: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80" },
            { name: "Priya Patel", percentage: "91.2%", image: "https://image2url.com/images/1759169383743-7efcb563-0254-4f08-a67d-d76cba91e902.jpeg" },
            { name: "Amit Kumar", percentage: "90.1%", image: "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80" },
            { name: "Gaurav", percentage: "89.7%", image: "https://images.unsplash.com/photo-1438761681033-6461ffad8d80?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80" },
            { name: "Shlok Paswan", percentage: "87%", image: "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80" },
        ];

        // NEW: Initialize Swiper
        document.addEventListener('DOMContentLoaded', function() {
            var swiper = new Swiper(".mySwiper", {
                spaceBetween: 0,
                centeredSlides: true,
                loop: true,
                autoplay: {
                    delay: 5000,
                    disableOnInteraction: false,
                },
                pagination: {
                    el: ".swiper-pagination",
                    clickable: true,
                },
                navigation: {
                    nextEl: ".swiper-button-next",
                    prevEl: ".swiper-button-prev",
                },
            });
        });

        // NEW: Realtime Database Functions
        async function saveToRealtimeDB(path, data) {
            try {
                await set(ref(realtimeDb, path), data);
                return true;
            } catch (error) {
                console.error("Error saving to Realtime DB:", error);
                return false;
            }
        }

        async function getFromRealtimeDB(path) {
            try {
                const snapshot = await get(child(ref(realtimeDb), path));
                return snapshot.exists() ? snapshot.val() : null;
            } catch (error) {
                console.error("Error reading from Realtime DB:", error);
                return null;
            }
        }

        // NEW: Real-time notifications using Realtime DB
        function setupRealtimeNotifications(userId) {
            const notificationsRef = ref(realtimeDb, `notifications/${userId}`);
            
            onValue(notificationsRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    // Convert object to array and show latest notification
                    const notifications = Object.values(data);
                    const latestNotification = notifications[notifications.length - 1];
                    
                    if (latestNotification && !latestNotification.read) {
                        showNotification(latestNotification.message, 'success');
                        
                        // Mark as read
                        set(ref(realtimeDb, `notifications/${userId}/${latestNotification.id}/read`), true);
                    }
                }
            });
        }

        // NEW: Real-time attendance updates
        function setupRealtimeAttendance(standard) {
            const attendanceRef = ref(realtimeDb, `attendance/${standard}`);
            
            onValue(attendanceRef, (snapshot) => {
                const data = snapshot.val();
                if (data && currentUserData.role === 'teacher') {
                    // Update attendance display in real-time
                    updateAttendanceDisplay(data);
                }
            });
        }

        // Populate toppers slider
        function populateToppers() {
            const slider = document.querySelector('.topper-slide');
            // Duplicate toppers to create seamless loop
            const allToppers = [...toppers, ...toppers, ...toppers];
            
            allToppers.forEach(topper => {
                const topperItem = document.createElement('div');
                topperItem.className = 'topper-item';
                topperItem.innerHTML = `
                    <img src="${topper.image}" alt="${topper.name}" class="topper-img">
                    <h5>${topper.name}</h5>
                    <p class="text-primary fw-bold">${topper.percentage}</p>
                `;
                slider.appendChild(topperItem);
            });
        }

        // Load events from Firestore
        async function loadEvents() {
            const eventsContainer = document.getElementById('eventsContainer');
            eventsContainer.innerHTML = '<div class="col-12 text-center"><p>Loading events...</p></div>';
            
            try {
                const q = query(collection(db, "events"), orderBy("date", "asc"));
                const querySnapshot = await getDocs(q);
                
                eventsContainer.innerHTML = '';
                
                if (querySnapshot.empty) {
                    // Add sample events if none exist
                    const sampleEvents = [
                        {
                            title: "Annual Sports Day",
                            description: "Join us for our exciting annual sports day with various competitions and activities for students of all ages.",
                            date: new Date(new Date().setDate(new Date().getDate() + 15)),
                            time: "9:00 AM - 4:00 PM",
                            location: "School Ground"
                        },
                        {
                            title: "Science Exhibition",
                            description: "Students will showcase their innovative science projects and experiments. Parents and community members are welcome.",
                            date: new Date(new Date().setDate(new Date().getDate() + 25)),
                            time: "10:00 AM - 2:00 PM",
                            location: "Science Lab & Auditorium"
                        }
                    ];
                    
                    for (const event of sampleEvents) {
                        await addDoc(collection(db, "events"), event);
                    }
                    
                    // Reload events
                    return loadEvents();
                }
                
                querySnapshot.forEach((doc) => {
                    const event = doc.data();
                    const eventDate = event.date.toDate ? event.date.toDate() : new Date(event.date);
                    const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                    
                    const eventHTML = `
                        <div class="col-lg-6 mb-4">
                            <div class="card event-card">
                                <div class="card-body p-4">
                                    <div class="event-date">
                                        <span class="day">${eventDate.getDate()}</span>
                                        <span class="month">${monthNames[eventDate.getMonth()]}</span>
                                    </div>
                                    <h4 class="card-title">${event.title}</h4>
                                    <p class="card-text">${event.description}</p>
                                    <div class="event-info">
                                        <p><i class="fas fa-clock me-2"></i> ${event.time}</p>
                                        <p><i class="fas fa-map-marker-alt me-2"></i> ${event.location}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    eventsContainer.innerHTML += eventHTML;
                });
            } catch (error) {
                console.error("Error loading events: ", error);
                eventsContainer.innerHTML = '<div class="col-12 text-center"><p>Error loading events</p></div>';
            }
        }

        // Enhanced Firebase Login Function
        async function loginWithFirebase(email, password, role, standard) {
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                currentUser = user;
                
                // Check user role in Firestore
                const docRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    currentUserData = userData;
                    
                    // Verify role matches
                    if (userData.role === role) {
                        // Check if standard matches for students/teachers
                        if ((role === 'student' || role === 'teacher') && 
                            userData.standard != standard) {
                            alert('Standard does not match your account. Please select the correct standard.');
                            await signOut(auth);
                            return;
                        }
                        
                        // Successful login
                        showNotification(`Login successful as ${role}!`, 'success');
                        
                        // NEW: Setup real-time features
                        setupRealtimeNotifications(user.uid);
                        if (userData.standard) {
                            setupRealtimeAttendance(userData.standard);
                        }
                        
                        // Close login modal
                        const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                        loginModal.hide();
                        
                        // Show dashboard modal
                        showDashboard(role, userData);
                    } else {
                        alert(`Your account is registered as ${userData.role}, not ${role}. Please select the correct role.`);
                        await signOut(auth);
                    }
                } else {
                    // Create user data if it doesn't exist (for existing auth users)
                    await setDoc(doc(db, "users", user.uid), {
                        email: user.email,
                        role: role,
                        standard: standard,
                        name: user.email.split('@')[0],
                        createdAt: new Date(),
                        lastUpdated: new Date()
                    });
                    
                    currentUserData = {
                        email: user.email,
                        role: role,
                        standard: standard,
                        name: user.email.split('@')[0]
                    };
                    
                    showNotification(`Login successful as ${role}!`, 'success');
                    const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                    loginModal.hide();
                    showDashboard(role, currentUserData);
                }
            } catch (error) {
                console.error("Login error:", error);
                const errorCode = error.code;
                
                if (errorCode === 'auth/user-not-found') {
                    alert('No account found with this email. Please check your email or contact administrator.');
                } else if (errorCode === 'auth/wrong-password') {
                    alert('Incorrect password. Please try again.');
                } else if (errorCode === 'auth/invalid-email') {
                    alert('Invalid email address format.');
                } else {
                    alert('Login error: ' + error.message);
                }
            }
        }

        // Enhanced User Creation Function
        async function createUserWithRole(email, password, userData) {
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Add user data to Firestore
                await setDoc(doc(db, "users", user.uid), {
                    ...userData,
                    email: email,
                    createdAt: new Date(),
                    lastUpdated: new Date()
                });
                
                // NEW: Also save to Realtime Database for real-time features
                await saveToRealtimeDB(`users/${user.uid}`, {
                    ...userData,
                    email: email,
                    lastActive: new Date().toISOString()
                });
                
                return { success: true, user: user, password: password };
            } catch (error) {
                console.error("Error creating user:", error);
                return { success: false, error: error.message };
            }
        }

        // Get actual statistics from Firestore
        async function getSchoolStatistics() {
            try {
                // Get student count
                const studentsQuery = query(collection(db, "users"), where("role", "==", "student"));
                const studentsSnapshot = await getDocs(studentsQuery);
                const studentCount = studentsSnapshot.size;
                
                // Get teacher count
                const teachersQuery = query(collection(db, "users"), where("role", "==", "teacher"));
                const teachersSnapshot = await getDocs(teachersQuery);
                const teacherCount = teachersSnapshot.size;
                
                // Get pending admissions count
                const admissionsQuery = query(collection(db, "admissions"), where("status", "==", "pending"));
                const admissionsSnapshot = await getDocs(admissionsQuery);
                const pendingAdmissionsCount = admissionsSnapshot.size;
                
                // Calculate average attendance in days
                let totalAttendanceDays = 0;
                let attendanceCount = 0;
                
                studentsSnapshot.forEach((doc) => {
                    const student = doc.data();
                    if (student.attendanceDays) {
                        totalAttendanceDays += student.attendanceDays;
                        attendanceCount++;
                    }
                });
                
                const averageAttendanceDays = attendanceCount > 0 ? Math.round(totalAttendanceDays / attendanceCount) : 0;
                
                return {
                    studentCount,
                    teacherCount,
                    pendingAdmissionsCount,
                    averageAttendanceDays
                };
            } catch (error) {
                console.error("Error getting statistics: ", error);
                return {
                    studentCount: 0,
                    teacherCount: 0,
                    pendingAdmissionsCount: 0,
                    averageAttendanceDays: 0
                };
            }
        }

        // Get student marks and rankings
        async function getStudentRankings() {
            try {
                const studentsQuery = query(collection(db, "users"), where("role", "==", "student"));
                const studentsSnapshot = await getDocs(studentsQuery);
                
                const students = [];
                studentsSnapshot.forEach((doc) => {
                    const student = doc.data();
                    student.id = doc.id;
                    students.push(student);
                });
                
                // Sort by percentage (descending)
                students.sort((a, b) => (b.percentage || 0) - (a.percentage || 0));
                
                // Add rank
                students.forEach((student, index) => {
                    student.rank = index + 1;
                });
                
                return students;
            } catch (error) {
                console.error("Error getting student rankings: ", error);
                return [];
            }
        }

        // Get admission applications with caste-wise ranking
        async function getAdmissionApplications() {
            try {
                const admissionsQuery = query(collection(db, "admissions"), where("status", "==", "pending"));
                const admissionsSnapshot = await getDocs(admissionsQuery);
                
                const applications = [];
                admissionsSnapshot.forEach((doc) => {
                    const application = doc.data();
                    application.id = doc.id;
                    applications.push(application);
                });
                
                // Sort by entrance marks (descending) within each caste category
                const casteCategories = {
                    'general': [],
                    'obc': [],
                    'sc': [],
                    'st': []
                };
                
                applications.forEach(app => {
                    if (casteCategories[app.casteCategory]) {
                        casteCategories[app.casteCategory].push(app);
                    }
                });
                
                // Sort each category by marks
                Object.keys(casteCategories).forEach(category => {
                    casteCategories[category].sort((a, b) => b.entranceMarks - a.entranceMarks);
                    
                    // Add rank within category
                    casteCategories[category].forEach((app, index) => {
                        app.casteRank = index + 1;
                    });
                });
                
                // Flatten back to single array
                const rankedApplications = [];
                Object.keys(casteCategories).forEach(category => {
                    rankedApplications.push(...casteCategories[category]);
                });
                
                return rankedApplications;
            } catch (error) {
                console.error("Error getting admission applications: ", error);
                return [];
            }
        }

        // Show dashboard based on role
        async function showDashboard(role, userData) {
            const dashboardContent = document.getElementById('dashboardContent');
            let dashboardHTML = '';
            
            switch(role) {
                case 'student':
                    dashboardHTML = await getStudentDashboard(userData);
                    break;
                    
                case 'teacher':
                    dashboardHTML = await getTeacherDashboard(userData);
                    break;
                    
                case 'principal':
                    dashboardHTML = await getPrincipalDashboard(userData);
                    break;
            }
            
            dashboardContent.innerHTML = dashboardHTML;
            
            // Show dashboard modal
            const dashboardModal = new bootstrap.Modal(document.getElementById('dashboardModal'));
            dashboardModal.show();
            
            // Load additional data based on role
            if (role === 'principal') {
                loadAdmissionApplications();
                loadStudentRankings();
            } else if (role === 'student') {
                loadStudentNotifications(currentUser.uid);
            }
        }

        // Student Dashboard
        async function getStudentDashboard(userData) {
            // Ensure userData has all required properties
            const safeUserData = {
                ...userData,
                name: userData.name || 'Student',
                standard: userData.standard || 'N/A',
                rollNo: userData.rollNo || 'N/A',
                casteCategory: userData.casteCategory || 'N/A',
                percentage: userData.percentage || 0,
                attendanceDays: userData.attendanceDays || 0,
                marks: userData.marks || {},
                rank: userData.rank || 'N/A'
            };

            return `
                <div class="profile-header">
                    <div class="position-relative d-inline-block">
                        <img src="${safeUserData.photoURL || 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80'}" 
                             class="profile-avatar" id="studentProfileImg">
                        <button class="btn btn-sm btn-outline-secondary position-absolute bottom-0 end-0 rounded-circle" 
                                onclick="showImageUploadModal()">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>
                    <h3>${safeUserData.name}</h3>
                    <p class="text-muted">Class ${safeUserData.standard} | Roll No: ${safeUserData.rollNo} | Caste: ${safeUserData.casteCategory}</p>
                    <button class="btn btn-outline-primary btn-sm mt-2" onclick="showChangePasswordModal()">
                        <i class="fas fa-key me-1"></i>Change Password
                    </button>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number">${safeUserData.percentage}%</div>
                            <div class="stats-label">Overall Percentage</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number">${safeUserData.attendanceDays}</div>
                            <div class="stats-label">Attendance (Days)</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number">${getGrade(safeUserData.percentage)}</div>
                            <div class="stats-label">Overall Grade</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number">${safeUserData.rank}</div>
                            <div class="stats-label">Class Rank</div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h4>Subject-wise Marks</h4>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Subject</th>
                                        <th>Marks</th>
                                        <th>Grade</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${generateMarksTable(safeUserData.marks)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h4>Notifications</h4>
                        <div class="list-group" id="studentNotifications">
                            <div class="list-group-item">
                                <p class="mb-1 text-muted">Loading notifications...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Teacher Dashboard
        async function getTeacherDashboard(userData) {
            const stats = await getTeacherStatistics(userData.standard);
            
            return `
                <div class="profile-header">
                    <div class="position-relative d-inline-block">
                        <img src="${userData.photoURL || 'https://images.unsplash.com/photo-1560250097-0b93528c311a?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80'}" 
                             class="profile-avatar" id="teacherProfileImg">
                        <button class="btn btn-sm btn-outline-secondary position-absolute bottom-0 end-0 rounded-circle" 
                                onclick="showImageUploadModal()">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>
                    <h3>${userData.name || 'Teacher'}</h3>
                    <p class="text-muted">Class ${userData.standard} Teacher | ${userData.subject || 'All Subjects'}</p>
                    <button class="btn btn-outline-primary btn-sm mt-2" onclick="showChangePasswordModal()">
                        <i class="fas fa-key me-1"></i>Change Password
                    </button>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number">${stats.studentCount}</div>
                            <div class="stats-label">Students</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number">${stats.averageAttendanceDays || 0}</div>
                            <div class="stats-label">Avg Attendance (Days)</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number">${stats.averagePercentage || 0}%</div>
                            <div class="stats-label">Average Percentage</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number">${stats.pendingEvaluations || 0}</div>
                            <div class="stats-label">Pending Evaluations</div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h4>Class ${userData.standard} Students</h4>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Roll No</th>
                                        <th>Name</th>
                                        <th>Attendance (Days)</th>
                                        <th>Percentage</th>
                                    </tr>
                                </thead>
                                <tbody id="teacherStudentsTable">
                                    ${await generateTeacherStudentsTable(userData.standard)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h4>Quick Actions</h4>
                        <div class="d-grid gap-2 mb-4">
                            <button class="btn btn-outline-primary" onclick="showAddStudentForm('${userData.standard}')">
                                <i class="fas fa-user-plus me-2"></i>Add New Student
                            </button>
                            <button class="btn btn-outline-primary" onclick="showUpdateRollNumbers('${userData.standard}')">
                                <i class="fas fa-sort-numeric-up me-2"></i>Update Roll Numbers
                            </button>
                            <button class="btn btn-outline-primary" onclick="showTakeAttendance('${userData.standard}')">
                                <i class="fas fa-clipboard-check me-2"></i>Take Attendance
                            </button>
                            <button class="btn btn-outline-primary" onclick="showUploadMarksForm('${userData.standard}')">
                                <i class="fas fa-upload me-2"></i>Upload Marks
                            </button>
                            <button class="btn btn-outline-primary" onclick="showSendNotificationForm('${userData.standard}')">
                                <i class="fas fa-bell me-2"></i>Send Notifications
                            </button>
                            <button class="btn btn-outline-primary" onclick="showAttendanceHistory()">
                                <i class="fas fa-history me-2"></i>Attendance History
                            </button>
                        </div>
                        
                        <h4>Recent Activities</h4>
                        <div class="list-group" id="teacherActivities">
                            <div class="list-group-item">
                                <p class="mb-1 text-muted">Loading activities...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Modals for teacher actions -->
                ${getTeacherModals(userData.standard)}
            `;
        }

        // Principal Dashboard
        async function getPrincipalDashboard(userData) {
            const stats = await getSchoolStatistics();
            
            return `
                <div class="profile-header">
                    <div class="position-relative d-inline-block">
                        <img src="${userData.photoURL || 'https://image2url.com/images/1759169830194-ed0790f0-558c-40d1-87a2-11c34ad98f88.jpg'}" 
                             class="profile-avatar" id="principalProfileImg">
                        <button class="btn btn-sm btn-outline-secondary position-absolute bottom-0 end-0 rounded-circle" 
                                onclick="showImageUploadModal()">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>
                    <h3>${userData.name || 'Mr. Fayaz Sir'}</h3>
                    <p class="text-muted">School Principal</p>
                    <button class="btn btn-outline-primary btn-sm mt-2" onclick="showChangePasswordModal()">
                        <i class="fas fa-key me-1"></i>Change Password
                    </button>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number">${stats.studentCount}</div>
                            <div class="stats-label">Total Students</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number">${stats.teacherCount}</div>
                            <div class="stats-label">Teaching Staff</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number">${stats.averageAttendanceDays}</div>
                            <div class="stats-label">Avg Attendance (Days)</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number" id="pendingAdmissions">${stats.pendingAdmissionsCount}</div>
                            <div class="stats-label">Pending Admissions</div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h4>Admission Applications</h4>
                        <div class="mb-3">
                            <label for="casteFilter" class="form-label">Filter by Caste:</label>
                            <select class="form-select" id="casteFilter" onchange="filterApplications()">
                                <option value="all">All Categories</option>
                                <option value="general">General</option>
                                <option value="obc">OBC</option>
                                <option value="sc">SC</option>
                                <option value="st">ST</option>
                            </select>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Class</th>
                                        <th>Caste</th>
                                        <th>Marks</th>
                                        <th>Rank</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="admissionsTable">
                                    <!-- Admission applications will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <h4 class="mt-4">Quick Actions</h4>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="showAddUserForm()">
                                <i class="fas fa-user-plus me-2"></i>Add New User
                            </button>
                            <button class="btn btn-outline-primary" onclick="showStudentDetails()">
                                <i class="fas fa-users me-2"></i>Student Details
                            </button>
                            <button class="btn btn-outline-primary" onclick="showFeesDashboard()">
                                <i class="fas fa-rupee-sign me-2"></i>Fees Management
                            </button>
                            <button class="btn btn-outline-primary" onclick="showEventManagement()">
                                <i class="fas fa-calendar-alt me-2"></i>Manage Events
                            </button>
                            <button class="btn btn-outline-primary" onclick="generateReports()">
                                <i class="fas fa-chart-bar me-2"></i>Generate Reports
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h4>Student Rankings (Caste-wise)</h4>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Name</th>
                                        <th>Class</th>
                                        <th>Caste</th>
                                        <th>Percentage</th>
                                    </tr>
                                </thead>
                                <tbody id="rankingsTable">
                                    <!-- Student rankings will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <h4 class="mt-4">School Statistics</h4>
                        <div class="list-group">
                            <div class="list-group-item d-flex justify-content-between">
                                <span>Students per Class:</span>
                                <span>Average 54</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span>Teacher-Student Ratio:</span>
                                <span>1:15</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between">
                                <span>Pass Percentage (Last Year):</span>
                                <span>98.7%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Modals for principal actions -->
                ${getPrincipalModals()}
            `;
        }

        // Enhanced Teacher Statistics
        async function getTeacherStatistics(standard) {
            try {
                const studentsQuery = query(
                    collection(db, "users"), 
                    where("role", "==", "student"), 
                    where("standard", "==", standard)
                );
                const studentsSnapshot = await getDocs(studentsQuery);
                
                let totalAttendanceDays = 0;
                let totalPercentage = 0;
                let studentCount = 0;
                
                studentsSnapshot.forEach(doc => {
                    const student = doc.data();
                    if (student.attendanceDays) totalAttendanceDays += student.attendanceDays;
                    if (student.percentage) totalPercentage += student.percentage;
                    studentCount++;
                });
                
                return {
                    studentCount: studentCount,
                    averageAttendanceDays: studentCount > 0 ? Math.round(totalAttendanceDays / studentCount) : 0,
                    averagePercentage: studentCount > 0 ? Math.round(totalPercentage / studentCount) : 0,
                    pendingEvaluations: 0
                };
            } catch (error) {
                console.error("Error getting teacher statistics: ", error);
                return { 
                    studentCount: 0, 
                    averageAttendanceDays: 0, 
                    averagePercentage: 0, 
                    pendingEvaluations: 0 
                };
            }
        }

        // Generate marks table for student dashboard
        function generateMarksTable(marks) {
            const subjects = Object.keys(marks);
            if (subjects.length === 0) {
                return '<tr><td colspan="3" class="text-center">No marks available</td></tr>';
            }
            
            let marksHTML = '';
            subjects.forEach(subject => {
                marksHTML += `
                    <tr>
                        <td>${subject}</td>
                        <td>${marks[subject]}/100</td>
                        <td>${getGrade(marks[subject])}</td>
                    </tr>
                `;
            });
            
            return marksHTML;
        }

        // Generate teacher students table - UPDATED: Sort by roll number
        async function generateTeacherStudentsTable(standard) {
            try {
                const studentsQuery = query(
                    collection(db, "users"), 
                    where("role", "==", "student"), 
                    where("standard", "==", standard)
                );
                const studentsSnapshot = await getDocs(studentsQuery);
                
                if (studentsSnapshot.empty) {
                    return '<tr><td colspan="4" class="text-center">No students in this class</td></tr>';
                }
                
                let students = [];
                studentsSnapshot.forEach(doc => {
                    const student = doc.data();
                    student.id = doc.id;
                    students.push(student);
                });
                
                // Sort students by roll number
                students.sort((a, b) => {
                    const rollA = a.rollNo || 9999;
                    const rollB = b.rollNo || 9999;
                    return rollA - rollB;
                });
                
                let studentsHTML = '';
                students.forEach(student => {
                    studentsHTML += `
                        <tr>
                            <td>${student.rollNo || 'N/A'}</td>
                            <td>${student.name}</td>
                            <td>${student.attendanceDays || 0}</td>
                            <td>${student.percentage || 0}%</td>
                        </tr>
                    `;
                });
                
                return studentsHTML;
            } catch (error) {
                console.error("Error generating teacher students table: ", error);
                return '<tr><td colspan="4" class="text-center">Error loading students</td></tr>';
            }
        }

        // Get grade from percentage
        function getGrade(percentage) {
            if (percentage >= 90) return 'A+';
            if (percentage >= 80) return 'A';
            if (percentage >= 70) return 'B+';
            if (percentage >= 60) return 'B';
            if (percentage >= 50) return 'C';
            return 'F';
        }

        // Get teacher modals HTML
        function getTeacherModals(standard) {
            return `
                <!-- Add Student Modal -->
                <div class="modal fade" id="addStudentModal">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Add New Student to Class ${standard}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="addStudentForm">
                                    <div class="mb-3">
                                        <label class="form-label">Student Name</label>
                                        <input type="text" class="form-control" id="newStudentName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Roll Number</label>
                                        <input type="number" class="form-control" id="newStudentRoll" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Parent Email</label>
                                        <input type="email" class="form-control" id="newStudentParentEmail">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Caste Category</label>
                                        <select class="form-select" id="newStudentCaste">
                                            <option value="general">General</option>
                                            <option value="obc">OBC</option>
                                            <option value="sc">SC</option>
                                            <option value="st">ST</option>
                                        </select>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="addNewStudent('${standard}')">Add Student</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Update Roll Numbers Modal -->
                <div class="modal fade" id="updateRollNumbersModal">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Update Roll Numbers for Class ${standard}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Current Roll No</th>
                                                <th>Student Name</th>
                                                <th>New Roll No</th>
                                            </tr>
                                        </thead>
                                        <tbody id="rollNumbersTable">
                                            <!-- Students will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="updateRollNumbers('${standard}')">Save Changes</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Marks Modal -->
                <div class="modal fade" id="uploadMarksModal">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Upload Marks for Class ${standard}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">Select Subject</label>
                                    <select class="form-select" id="marksSubject">
                                        <option value="math">Mathematics</option>
                                        <option value="science">Science</option>
                                        <option value="english">English</option>
                                        <option value="hindi">Hindi</option>
                                        <option value="social">Social Studies</option>
                                    </select>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Roll No</th>
                                                <th>Student Name</th>
                                                <th>Marks (out of 100)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="marksTable">
                                            <!-- Students will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="uploadMarks('${standard}')">Upload Marks</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Send Notification Modal -->
                <div class="modal fade" id="sendNotificationModal">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Send Notification to Class ${standard}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="notificationForm">
                                    <div class="mb-3">
                                        <label class="form-label">Notification Title</label>
                                        <input type="text" class="form-control" id="notificationTitle" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Notification Message</label>
                                        <textarea class="form-control" id="notificationMessage" rows="4" required></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Priority</label>
                                        <select class="form-select" id="notificationPriority">
                                            <option value="low">Low</option>
                                            <option value="medium" selected>Medium</option>
                                            <option value="high">High</option>
                                        </select>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="sendNotification('${standard}')">Send Notification</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Change Password Modal -->
                <div class="modal fade" id="changePasswordModal">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Change Password</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="changePasswordForm">
                                    <div class="mb-3">
                                        <label class="form-label">Current Password</label>
                                        <input type="password" class="form-control" id="currentPassword" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">New Password</label>
                                        <input type="password" class="form-control" id="newPassword" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Confirm New Password</label>
                                        <input type="password" class="form-control" id="confirmPassword" required>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="changePassword()">Change Password</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Get principal modals HTML
        function getPrincipalModals() {
            return `
                <!-- Add User Modal is now defined in HTML above with password fields -->

                <!-- Manage Events Modal -->
                <div class="modal fade" id="manageEventsModal">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Manage School Events</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <button class="btn btn-primary mb-3" onclick="showAddEventForm()">
                                    <i class="fas fa-plus me-2"></i>Add New Event
                                </button>
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Title</th>
                                                <th>Date</th>
                                                <th>Time</th>
                                                <th>Location</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="eventsManagementTable">
                                            <!-- Events will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Event Modal -->
                <div class="modal fade" id="addEventModal">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Add New Event</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="addEventForm">
                                    <div class="mb-3">
                                        <label class="form-label">Event Title</label>
                                        <input type="text" class="form-control" id="eventTitle" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Description</label>
                                        <textarea class="form-control" id="eventDescription" rows="3" required></textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Date</label>
                                            <input type="date" class="form-control" id="eventDate" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Time</label>
                                            <input type="time" class="form-control" id="eventTime" required>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Location</label>
                                        <input type="text" class="form-control" id="eventLocation" required>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="addNewEvent()">Add Event</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Generate Reports Modal -->
                <div class="modal fade" id="generateReportsModal">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Generate Reports</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">Select Report Type</label>
                                    <select class="form-select" id="reportType">
                                        <option value="attendance">Attendance Report</option>
                                        <option value="performance">Academic Performance</option>
                                        <option value="admissions">Admissions Report</option>
                                        <option value="financial">Financial Report</option>
                                    </select>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">From Date</label>
                                        <input type="date" class="form-control" id="reportFromDate">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">To Date</label>
                                        <input type="date" class="form-control" id="reportToDate">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Format</label>
                                    <select class="form-select" id="reportFormat">
                                        <option value="pdf">PDF</option>
                                        <option value="excel">Excel</option>
                                        <option value="csv">CSV</option>
                                    </select>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="generateReport()">Generate Report</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // NEW: Show Student Details for Principal
        window.showStudentDetails = function() {
            const modal = new bootstrap.Modal(document.getElementById('studentDetailsModal'));
            
            // Load classes for the select
            loadClassesForSelect('principalClassSelect');
            
            // Add event listener for class change
            document.getElementById('principalClassSelect').addEventListener('change', function() {
                const standard = this.value;
                if (standard) {
                    loadStudentsForPrincipal(standard);
                }
            });
            
            modal.show();
        };

        // NEW: Show Fees Dashboard for Principal
        window.showFeesDashboard = function() {
            const modal = new bootstrap.Modal(document.getElementById('feesDashboardModal'));
            
            // Load classes for the select
            loadClassesForSelect('feesClassSelect');
            
            // Add event listener for class change
            document.getElementById('feesClassSelect').addEventListener('change', function() {
                const standard = this.value;
                if (standard) {
                    loadStudentsForFees(standard);
                }
            });
            
            modal.show();
        };

        // NEW: Show Attendance History for Teacher
        window.showAttendanceHistory = function() {
            const modal = new bootstrap.Modal(document.getElementById('attendanceHistoryModal'));
            
            // Load classes for the select
            loadClassesForSelect('historyClassSelect');
            
            // Set default date range (last 30 days)
            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);
            
            document.getElementById('historyDateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('historyDateTo').value = today.toISOString().split('T')[0];
            
            // Add event listener for filters
            document.getElementById('historyClassSelect').addEventListener('change', loadAttendanceHistory);
            document.getElementById('historyDateFrom').addEventListener('change', loadAttendanceHistory);
            document.getElementById('historyDateTo').addEventListener('change', loadAttendanceHistory);
            
            // Load initial data
            loadAttendanceHistory();
            
            modal.show();
        };

        // NEW: Load classes for select dropdowns
        async function loadClassesForSelect(selectId) {
            try {
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const standardsSet = new Set();
                
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    if (userData.standard && userData.role === 'student') {
                        standardsSet.add(userData.standard);
                    }
                });
                
                const classes = Array.from(standardsSet).sort();
                const classSelect = document.getElementById(selectId);
                
                classSelect.innerHTML = '<option value="">-- Select Class --</option>';
                classes.forEach(classItem => {
                    const option = document.createElement('option');
                    option.value = classItem;
                    option.textContent = `Class ${classItem}`;
                    classSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading classes for select:', error);
            }
        }

        // NEW: Load students for principal dashboard
        async function loadStudentsForPrincipal(standard) {
            try {
                const studentsQuery = query(
                    collection(db, "users"), 
                    where("role", "==", "student"), 
                    where("standard", "==", standard)
                );
                const studentsSnapshot = await getDocs(studentsQuery);
                
                const studentsTable = document.getElementById('principalStudentsTable');
                studentsTable.innerHTML = '';
                
                if (studentsSnapshot.empty) {
                    studentsTable.innerHTML = '<tr><td colspan="7" class="text-center">No students found</td></tr>';
                    return;
                }
                
                let students = [];
                studentsSnapshot.forEach(doc => {
                    const student = doc.data();
                    student.id = doc.id;
                    students.push(student);
                });
                
                // Sort students by roll number
                students.sort((a, b) => {
                    const rollA = a.rollNo || 9999;
                    const rollB = b.rollNo || 9999;
                    return rollA - rollB;
                });
                
                students.forEach(student => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${student.rollNo || 'N/A'}</td>
                        <td>${student.name}</td>
                        <td><span class="badge badge-caste-${student.casteCategory || 'general'}">${(student.casteCategory || 'general').toUpperCase()}</span></td>
                        <td>${student.attendanceDays || 0}</td>
                        <td>${student.percentage || 0}%</td>
                        <td>${getFeesStatus(student)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewStudentDetails('${student.id}')">View</button>
                        </td>
                    `;
                    studentsTable.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading students for principal:', error);
                document.getElementById('principalStudentsTable').innerHTML = '<tr><td colspan="7" class="text-center">Error loading students</td></tr>';
            }
        }

        // NEW: Load students for fees dashboard
        async function loadStudentsForFees(standard) {
            try {
                const studentsQuery = query(
                    collection(db, "users"), 
                    where("role", "==", "student"), 
                    where("standard", "==", standard)
                );
                const studentsSnapshot = await getDocs(studentsQuery);
                
                const feesTable = document.getElementById('feesStudentsTable');
                feesTable.innerHTML = '';
                
                if (studentsSnapshot.empty) {
                    feesTable.innerHTML = '<tr><td colspan="7" class="text-center">No students found</td></tr>';
                    return;
                }
                
                let students = [];
                studentsSnapshot.forEach(doc => {
                    const student = doc.data();
                    student.id = doc.id;
                    students.push(student);
                });
                
                // Sort students by roll number
                students.sort((a, b) => {
                    const rollA = a.rollNo || 9999;
                    const rollB = b.rollNo || 9999;
                    return rollA - rollB;
                });
                
                students.forEach(student => {
                    const totalFees = student.totalFees || 0;
                    const paidFees = student.paidFees || 0;
                    const dueFees = totalFees - paidFees;
                    const lastPaymentDate = student.lastPaymentDate ? new Date(student.lastPaymentDate).toLocaleDateString() : 'N/A';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${student.rollNo || 'N/A'}</td>
                        <td>${student.name}</td>
                        <td>₹${totalFees}</td>
                        <td>₹${paidFees}</td>
                        <td>₹${dueFees}</td>
                        <td>${lastPaymentDate}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="updateStudentFees('${student.id}', '${student.name}', ${totalFees}, ${paidFees})">Update</button>
                        </td>
                    `;
                    feesTable.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading students for fees:', error);
                document.getElementById('feesStudentsTable').innerHTML = '<tr><td colspan="7" class="text-center">Error loading students</td></tr>';
            }
        }

        // NEW: Load attendance history
        async function loadAttendanceHistory() {
            try {
                const classSelect = document.getElementById('historyClassSelect');
                const dateFrom = document.getElementById('historyDateFrom').value;
                const dateTo = document.getElementById('historyDateTo').value;
                
                if (!dateFrom || !dateTo) {
                    document.getElementById('attendanceHistoryTable').innerHTML = '<tr><td colspan="8" class="text-center">Please select date range</td></tr>';
                    return;
                }
                
                const startDate = new Date(dateFrom);
                const endDate = new Date(dateTo);
                endDate.setHours(23, 59, 59, 999); // End of day
                
                let attendanceQuery;
                
                if (classSelect.value) {
                    // Filter by class
                    attendanceQuery = query(
                        collection(db, "attendance"),
                        where("standard", "==", classSelect.value),
                        where("date", ">=", Timestamp.fromDate(startDate)),
                        where("date", "<=", Timestamp.fromDate(endDate)),
                        orderBy("date", "desc")
                    );
                } else {
                    // Get all classes
                    attendanceQuery = query(
                        collection(db, "attendance"),
                        where("date", ">=", Timestamp.fromDate(startDate)),
                        where("date", "<=", Timestamp.fromDate(endDate)),
                        orderBy("date", "desc")
                    );
                }
                
                const attendanceSnapshot = await getDocs(attendanceQuery);
                
                const historyTable = document.getElementById('attendanceHistoryTable');
                historyTable.innerHTML = '';
                
                if (attendanceSnapshot.empty) {
                    historyTable.innerHTML = '<tr><td colspan="8" class="text-center">No attendance records found</td></tr>';
                    return;
                }
                
                // Group attendance by date and class
                const attendanceByDate = {};
                
                attendanceSnapshot.forEach(doc => {
                    const record = doc.data();
                    const date = record.date.toDate().toLocaleDateString();
                    const classKey = record.standard;
                    
                    if (!attendanceByDate[date]) {
                        attendanceByDate[date] = {};
                    }
                    
                    if (!attendanceByDate[date][classKey]) {
                        attendanceByDate[date][classKey] = {
                            present: 0,
                            absent: 0,
                            late: 0,
                            leftEarly: 0,
                            markedBy: record.markedBy,
                            timestamp: record.markedAt
                        };
                    }
                    
                    if (record.status === 'present') attendanceByDate[date][classKey].present++;
                    if (record.status === 'absent') attendanceByDate[date][classKey].absent++;
                    if (record.status === 'late') attendanceByDate[date][classKey].late++;
                    if (record.status === 'left-early') attendanceByDate[date][classKey].leftEarly++;
                });
                
                // Display grouped attendance
                Object.keys(attendanceByDate).forEach(date => {
                    Object.keys(attendanceByDate[date]).forEach(classKey => {
                        const record = attendanceByDate[date][classKey];
                        const row = document.createElement('tr');
                        
                        // Get teacher name who marked attendance
                        let markedByName = 'Unknown';
                        if (record.markedBy) {
                            // In a real app, you would fetch the teacher's name from Firestore
                            markedByName = 'Teacher';
                        }
                        
                        row.innerHTML = `
                            <td>${date}</td>
                            <td>Class ${classKey}</td>
                            <td>${record.present}</td>
                            <td>${record.absent}</td>
                            <td>${record.late}</td>
                            <td>${record.leftEarly}</td>
                            <td>${markedByName}</td>
                            <td>${record.timestamp ? new Date(record.timestamp.toDate ? record.timestamp.toDate() : record.timestamp).toLocaleTimeString() : 'N/A'}</td>
                        `;
                        historyTable.appendChild(row);
                    });
                });
            } catch (error) {
                console.error('Error loading attendance history:', error);
                document.getElementById('attendanceHistoryTable').innerHTML = '<tr><td colspan="8" class="text-center">Error loading attendance history</td></tr>';
            }
        }

        // NEW: Get fees status for student
        function getFeesStatus(student) {
            const totalFees = student.totalFees || 0;
            const paidFees = student.paidFees || 0;
            
            if (paidFees >= totalFees) {
                return '<span class="badge bg-success">Paid</span>';
            } else if (paidFees > 0) {
                return '<span class="badge bg-warning">Partial</span>';
            } else {
                return '<span class="badge bg-danger">Pending</span>';
            }
        }

        // NEW: Update student fees
        window.updateStudentFees = function(studentId, studentName, totalFees, paidFees) {
            document.getElementById('updateFeesStudentId').value = studentId;
            document.getElementById('updateFeesStudentName').value = studentName;
            document.getElementById('updateFeesTotal').value = totalFees;
            document.getElementById('updateFeesPaid').value = paidFees;
            document.getElementById('updateFeesDate').value = new Date().toISOString().split('T')[0];
            
            const modal = new bootstrap.Modal(document.getElementById('updateFeesModal'));
            modal.show();
        };

        // NEW: Save fees update
        window.saveFeesUpdate = async function() {
            const studentId = document.getElementById('updateFeesStudentId').value;
            const totalFees = parseFloat(document.getElementById('updateFeesTotal').value);
            const paidFees = parseFloat(document.getElementById('updateFeesPaid').value);
            const paymentDate = document.getElementById('updateFeesDate').value;
            
            if (!studentId || isNaN(totalFees) || isNaN(paidFees) || !paymentDate) {
                showNotification('Please fill all fields correctly', 'error');
                return;
            }
            
            if (paidFees > totalFees) {
                showNotification('Paid fees cannot be more than total fees', 'error');
                return;
            }
            
            try {
                await updateDoc(doc(db, "users", studentId), {
                    totalFees: totalFees,
                    paidFees: paidFees,
                    lastPaymentDate: new Date(paymentDate),
                    lastUpdated: new Date()
                });
                
                showNotification('Fees updated successfully!', 'success');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('updateFeesModal'));
                modal.hide();
                
                // Refresh fees table if open
                const feesClassSelect = document.getElementById('feesClassSelect');
                if (feesClassSelect.value) {
                    loadStudentsForFees(feesClassSelect.value);
                }
                
            } catch (error) {
                console.error('Error updating fees:', error);
                showNotification('Error updating fees. Please try again.', 'error');
            }
        };

        // NEW: View student details
        window.viewStudentDetails = async function(studentId) {
            try {
                const studentDoc = await getDoc(doc(db, "users", studentId));
                if (studentDoc.exists()) {
                    const student = studentDoc.data();
                    alert(`Student Details:\n\nName: ${student.name}\nClass: ${student.standard}\nRoll No: ${student.rollNo || 'N/A'}\nCaste: ${student.casteCategory || 'N/A'}\nAttendance Days: ${student.attendanceDays || 0}\nPercentage: ${student.percentage || 0}%\nFees Status: ${getFeesStatus(student).replace(/<[^>]*>/g, '')}`);
                }
            } catch (error) {
                console.error('Error viewing student details:', error);
                showNotification('Error loading student details', 'error');
            }
        };

        // Teacher dashboard functions
        window.showAddStudentForm = function(standard) {
            const modal = new bootstrap.Modal(document.getElementById('addStudentModal'));
            modal.show();
        };

        window.showUpdateRollNumbers = async function(standard) {
            // Load students for the class
            try {
                const studentsQuery = query(
                    collection(db, "users"), 
                    where("role", "==", "student"), 
                    where("standard", "==", standard)
                );
                const studentsSnapshot = await getDocs(studentsQuery);
                
                let students = [];
                studentsSnapshot.forEach(doc => {
                    const student = doc.data();
                    student.id = doc.id;
                    students.push(student);
                });
                
                // Sort students by current roll number
                students.sort((a, b) => {
                    const rollA = a.rollNo || 9999;
                    const rollB = b.rollNo || 9999;
                    return rollA - rollB;
                });
                
                let studentsHTML = '';
                students.forEach(student => {
                    studentsHTML += `
                        <tr>
                            <td>${student.rollNo || 'N/A'}</td>
                            <td>${student.name}</td>
                            <td>
                                <input type="number" class="form-control" value="${student.rollNo || ''}" 
                                       data-id="${student.id}">
                            </td>
                        </tr>
                    `;
                });
                
                document.getElementById('rollNumbersTable').innerHTML = studentsHTML;
                
                const modal = new bootstrap.Modal(document.getElementById('updateRollNumbersModal'));
                modal.show();
            } catch (error) {
                console.error("Error loading students for roll number update: ", error);
                alert("Error loading students. Please try again.");
            }
        };

        window.showTakeAttendance = function(standard) {
            // Set the class in the attendance modal
            document.getElementById('attendanceClass').value = standard;
            
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendanceDate').value = today;
            
            // Load classes for the attendance modal
            loadClassesForAttendance();
            
            // Show the attendance modal
            const modal = new bootstrap.Modal(document.getElementById('attendanceModal'));
            modal.show();
            
            // Load students for attendance
            loadStudentsForAttendance(standard);
        };

        window.showUploadMarksForm = async function(standard) {
            // Load students for the class
            try {
                const studentsQuery = query(
                    collection(db, "users"), 
                    where("role", "==", "student"), 
                    where("standard", "==", standard)
                );
                const studentsSnapshot = await getDocs(studentsQuery);
                
                let students = [];
                studentsSnapshot.forEach(doc => {
                    const student = doc.data();
                    student.id = doc.id;
                    students.push(student);
                });
                
                // Sort students by roll number
                students.sort((a, b) => {
                    const rollA = a.rollNo || 9999;
                    const rollB = b.rollNo || 9999;
                    return rollA - rollB;
                });
                
                let marksHTML = '';
                students.forEach(student => {
                    marksHTML += `
                        <tr>
                            <td>${student.rollNo || 'N/A'}</td>
                            <td>${student.name}</td>
                            <td>
                                <input type="number" class="form-control" min="0" max="100" 
                                       data-id="${student.id}">
                            </td>
                        </tr>
                    `;
                });
                
                document.getElementById('marksTable').innerHTML = marksHTML;
                
                const modal = new bootstrap.Modal(document.getElementById('uploadMarksModal'));
                modal.show();
            } catch (error) {
                console.error("Error loading students for marks upload: ", error);
                alert("Error loading students. Please try again.");
            }
        };

        window.showSendNotificationForm = function(standard) {
            const modal = new bootstrap.Modal(document.getElementById('sendNotificationModal'));
            modal.show();
        };

        window.showChangePasswordModal = function() {
            const modal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
            modal.show();
        };

        // Principal dashboard functions
        window.showAddUserForm = function() {
            const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
            
            // Show/hide standard field based on role selection
            document.getElementById('newUserRole').addEventListener('change', function() {
                const standardField = document.getElementById('newUserStandardField');
                if (this.value === 'student' || this.value === 'teacher') {
                    standardField.style.display = 'block';
                } else {
                    standardField.style.display = 'none';
                }
            });
            
            modal.show();
        };

        window.showEventManagement = async function() {
            // Load events for management
            try {
                const eventsQuery = query(collection(db, "events"), orderBy("date", "asc"));
                const eventsSnapshot = await getDocs(eventsQuery);
                
                let eventsHTML = '';
                eventsSnapshot.forEach(doc => {
                    const event = doc.data();
                    const eventDate = event.date.toDate ? event.date.toDate() : new Date(event.date);
                    
                    eventsHTML += `
                        <tr>
                            <td>${event.title}</td>
                            <td>${eventDate.toLocaleDateString()}</td>
                            <td>${event.time}</td>
                            <td>${event.location}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteEvent('${doc.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                document.getElementById('eventsManagementTable').innerHTML = eventsHTML;
                
                const modal = new bootstrap.Modal(document.getElementById('manageEventsModal'));
                modal.show();
            } catch (error) {
                console.error("Error loading events for management: ", error);
                alert("Error loading events. Please try again.");
            }
        };

        window.showAddEventForm = function() {
            const modal = new bootstrap.Modal(document.getElementById('addEventModal'));
            modal.show();
        };

        window.generateReports = function() {
            const modal = new bootstrap.Modal(document.getElementById('generateReportsModal'));
            modal.show();
        };

        // Implementation of the actual functions
        window.addNewStudent = async function(standard) {
            const name = document.getElementById('newStudentName').value;
            const rollNo = document.getElementById('newStudentRoll').value;
            const parentEmail = document.getElementById('newStudentParentEmail').value;
            const caste = document.getElementById('newStudentCaste').value;
            
            if (!name || !rollNo) {
                alert('Please fill in all required fields');
                return;
            }
            
            try {
                // Create student account
                const studentEmail = `student${rollNo}class${standard}@yashrajenglishhighschool.in`;
                const password = generatePassword();
                
                const userData = {
                    name: name,
                    rollNo: parseInt(rollNo),
                    standard: standard,
                    parentEmail: parentEmail,
                    casteCategory: caste,
                    role: 'student',
                    attendanceDays: 0,
                    percentage: 0,
                    marks: {},
                    totalFees: 0,
                    paidFees: 0
                };
                
                const result = await createUserWithRole(studentEmail, password, userData);
                
                if (result.success) {
                    alert(`Student added successfully!\n\nLogin Details:\nEmail: ${studentEmail}\nPassword: ${password}\n\nPlease save this password securely.`);
                    
                    // Close modal and reset form
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addStudentModal'));
                    modal.hide();
                    document.getElementById('addStudentForm').reset();
                    
                    // Refresh the dashboard
                    showDashboard(currentUserData.role, currentUserData);
                    
                } else {
                    alert('Error adding student: ' + result.error);
                }
                
            } catch (error) {
                console.error('Error adding student:', error);
                alert('Error adding student. Please try again.');
            }
        };

        // UPDATED: Add New User with Custom Password
        window.addNewUser = async function() {
            const name = document.getElementById('newUserName').value;
            const email = document.getElementById('newUserEmail').value;
            const role = document.getElementById('newUserRole').value;
            const standard = document.getElementById('newUserStandard').value;
            const password = document.getElementById('newUserPassword').value;
            const confirmPassword = document.getElementById('newUserConfirmPassword').value;
            
            if (!name || !email || !role || !password) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }
            
            if (password.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }
            
            if ((role === 'student' || role === 'teacher') && !standard) {
                alert('Please select a standard for this user');
                return;
            }
            
            // Show loading state
            const submitBtn = document.querySelector('#addUserModal .btn-primary');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating User...';
            submitBtn.disabled = true;
            
            try {
                // Prepare user data
                const userData = {
                    name: name,
                    role: role,
                    standard: (role === 'student' || role === 'teacher') ? standard : null,
                    attendanceDays: role === 'student' ? 0 : null,
                    percentage: role === 'student' ? 0 : null,
                    marks: role === 'student' ? {} : null,
                    totalFees: role === 'student' ? 0 : null,
                    paidFees: role === 'student' ? 0 : null
                };
                
                const result = await createUserWithRole(email, password, userData);
                
                if (result.success) {
                    showNotification(`User added successfully!`, 'success');
                    
                    // Close modal and reset form
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
                    modal.hide();
                    document.getElementById('addUserForm').reset();
                    
                    // Refresh the dashboard if principal
                    if (currentUserData.role === 'principal') {
                        showDashboard('principal', currentUserData);
                    }
                } else {
                    alert('Error adding user: ' + result.error);
                }
                
            } catch (error) {
                console.error('Error adding user:', error);
                alert('Error adding user. Please try again.');
            } finally {
                // Reset button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        };

        window.updateRollNumbers = async function(standard) {
            const inputs = document.querySelectorAll('#rollNumbersTable input');
            const updates = [];
            
            for (const input of inputs) {
                const newRollNo = input.value;
                const studentId = input.getAttribute('data-id');
                
                if (newRollNo && studentId) {
                    updates.push({
                        id: studentId,
                        rollNo: parseInt(newRollNo)
                    });
                }
            }
            
            if (updates.length === 0) {
                alert('No changes to save');
                return;
            }
            
            try {
                for (const update of updates) {
                    await updateDoc(doc(db, "users", update.id), {
                        rollNo: update.rollNo,
                        lastUpdated: new Date()
                    });
                }
                
                alert('Roll numbers updated successfully!');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('updateRollNumbersModal'));
                modal.hide();
                
                // Refresh the dashboard
                showDashboard(currentUserData.role, currentUserData);
                
            } catch (error) {
                console.error('Error updating roll numbers:', error);
                alert('Error updating roll numbers. Please try again.');
            }
        };

        window.uploadMarks = async function(standard) {
            const subject = document.getElementById('marksSubject').value;
            const inputs = document.querySelectorAll('#marksTable input');
            const updates = [];
            
            for (const input of inputs) {
                const marks = input.value;
                const studentId = input.getAttribute('data-id');
                
                if (marks && studentId) {
                    updates.push({
                        id: studentId,
                        marks: parseInt(marks)
                    });
                }
            }
            
            if (updates.length === 0) {
                alert('No marks to upload');
                return;
            }
            
            try {
                for (const update of updates) {
                    // Get current student data
                    const studentDoc = await getDoc(doc(db, "users", update.id));
                    const studentData = studentDoc.data();
                    
                    // Update marks for the specific subject
                    const updatedMarks = {
                        ...studentData.marks,
                        [subject]: update.marks
                    };
                    
                    // Calculate new percentage
                    const subjects = Object.keys(updatedMarks);
                    const totalMarks = subjects.reduce((sum, subj) => sum + updatedMarks[subj], 0);
                    const newPercentage = subjects.length > 0 ? Math.round(totalMarks / subjects.length) : 0;
                    
                    await updateDoc(doc(db, "users", update.id), {
                        marks: updatedMarks,
                        percentage: newPercentage,
                        lastUpdated: new Date()
                    });
                }
                
                alert('Marks uploaded successfully!');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('uploadMarksModal'));
                modal.hide();
                
            } catch (error) {
                console.error('Error uploading marks:', error);
                alert('Error uploading marks. Please try again.');
            }
        };

        // UPDATED: Send Notification - Now stores in Firestore for students to see
        window.sendNotification = async function(standard) {
            const title = document.getElementById('notificationTitle').value;
            const message = document.getElementById('notificationMessage').value;
            const priority = document.getElementById('notificationPriority').value;
            
            if (!title || !message) {
                alert('Please fill in all required fields');
                return;
            }
            
            try {
                // Get students in the class
                const studentsQuery = query(
                    collection(db, "users"), 
                    where("role", "==", "student"), 
                    where("standard", "==", standard)
                );
                const studentsSnapshot = await getDocs(studentsQuery);
                
                // Create notification for each student
                const batch = writeBatch(db);
                
                studentsSnapshot.forEach(doc => {
                    const notificationRef = doc(collection(db, "notifications"));
                    batch.set(notificationRef, {
                        studentId: doc.id,
                        title: title,
                        message: message,
                        priority: priority,
                        timestamp: new Date(),
                        read: false,
                        sentBy: currentUser.uid,
                        sentByName: currentUserData.name || 'Teacher'
                    });
                });
                
                await batch.commit();
                
                alert('Notification sent successfully!');
                
                // Close modal and reset form
                const modal = bootstrap.Modal.getInstance(document.getElementById('sendNotificationModal'));
                modal.hide();
                document.getElementById('notificationForm').reset();
                
            } catch (error) {
                console.error('Error sending notification:', error);
                alert('Error sending notification. Please try again.');
            }
        };

        window.changePassword = async function() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                alert('Please fill in all fields');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('New passwords do not match');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }
            
            try {
                // Reauthenticate user
                const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
                await reauthenticateWithCredential(currentUser, credential);
                
                // Update password
                await updatePassword(currentUser, newPassword);
                
                alert('Password changed successfully!');
                
                // Close modal and reset form
                const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
                modal.hide();
                document.getElementById('changePasswordForm').reset();
                
            } catch (error) {
                console.error('Error changing password:', error);
                
                if (error.code === 'auth/wrong-password') {
                    alert('Current password is incorrect.');
                } else if (error.code === 'auth/requires-recent-login') {
                    alert('Please log in again to change your password.');
                } else {
                    alert('Error changing password: ' + error.message);
                }
            }
        };

        window.addNewEvent = async function() {
            const title = document.getElementById('eventTitle').value;
            const description = document.getElementById('eventDescription').value;
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const location = document.getElementById('eventLocation').value;
            
            if (!title || !description || !date || !time || !location) {
                alert('Please fill in all fields');
                return;
            }
            
            try {
                await addDoc(collection(db, "events"), {
                    title: title,
                    description: description,
                    date: new Date(date),
                    time: time,
                    location: location,
                    createdAt: new Date()
                });
                
                alert('Event added successfully!');
                
                // Close modal and reset form
                const modal = bootstrap.Modal.getInstance(document.getElementById('addEventModal'));
                modal.hide();
                document.getElementById('addEventForm').reset();
                
                // Refresh events on the main page
                loadEvents();
                
            } catch (error) {
                console.error('Error adding event:', error);
                alert('Error adding event. Please try again.');
            }
        };

        window.deleteEvent = async function(eventId) {
            if (confirm('Are you sure you want to delete this event?')) {
                try {
                    await deleteDoc(doc(db, "events", eventId));
                    
                    alert('Event deleted successfully!');
                    
                    // Refresh the events management table
                    showEventManagement();
                    
                    // Refresh events on the main page
                    loadEvents();
                    
                } catch (error) {
                    console.error('Error deleting event:', error);
                    alert('Error deleting event. Please try again.');
                }
            }
        };

        window.generateReport = function() {
            const reportType = document.getElementById('reportType').value;
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;
            const format = document.getElementById('reportFormat').value;
            
            // In a real application, this would generate an actual report
            // For this demo, we'll just show a confirmation
            alert(`Report generated successfully!\nType: ${reportType}\nFormat: ${format}\nDate Range: ${fromDate} to ${toDate}`);
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('generateReportsModal'));
            modal.hide();
        };

        // Load admission applications for principal
        async function loadAdmissionApplications() {
            const applications = await getAdmissionApplications();
            const admissionsTable = document.getElementById('admissionsTable');
            admissionsTable.innerHTML = '';
            
            applications.forEach(app => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${app.studentName}</td>
                    <td>Class ${app.applyingFor}</td>
                    <td><span class="badge badge-caste-${app.casteCategory}">${app.casteCategory.toUpperCase()}</span></td>
                    <td>${app.entranceMarks}/100</td>
                    <td>${app.casteRank}</td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="approveApplication('${app.id}', '${app.studentName}', '${app.email}')">Approve</button>
                        <button class="btn btn-sm btn-danger" onclick="rejectApplication('${app.id}')">Reject</button>
                        <button class="btn btn-sm btn-info" onclick="viewApplication('${app.id}')">View</button>
                    </td>
                `;
                admissionsTable.appendChild(row);
            });
        }

        // Load student rankings for principal
        async function loadStudentRankings() {
            const students = await getStudentRankings();
            const rankingsTable = document.getElementById('rankingsTable');
            rankingsTable.innerHTML = '';
            
            students.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.rank}</td>
                    <td>${student.name}</td>
                    <td>Class ${student.standard}</td>
                    <td><span class="badge badge-caste-${student.casteCategory || 'general'}">${(student.casteCategory || 'general').toUpperCase()}</span></td>
                    <td>${student.percentage || 0}%</td>
                `;
                rankingsTable.appendChild(row);
            });
        }

        // Approve admission application
        window.approveApplication = async function(applicationId, studentName, email) {
            if (confirm(`Are you sure you want to approve ${studentName}'s application? This will create a student account.`)) {
                try {
                    // Get application data first
                    const appDoc = await getDoc(doc(db, "admissions", applicationId));
                    if (!appDoc.exists()) {
                        alert('Application not found!');
                        return;
                    }
                    
                    const app = appDoc.data();
                    
                    // Generate student email if not provided
                    const studentEmail = email || `student${appDoc.id}@yashrajenglishhighschool.in`;
                    const password = generatePassword();
                    
                    // Prepare student data
                    const studentData = {
                        name: app.studentName,
                        role: 'student',
                        standard: app.applyingFor,
                        casteCategory: app.casteCategory,
                        parentName: app.parentName,
                        parentEmail: app.email,
                        phone: app.phone,
                        address: app.address,
                        dob: app.dob,
                        gender: app.gender,
                        attendanceDays: 0,
                        percentage: 0,
                        marks: {},
                        rollNo: await generateRollNumber(app.applyingFor),
                        totalFees: 0,
                        paidFees: 0
                    };
                    
                    const result = await createUserWithRole(studentEmail, password, studentData);
                    
                    if (result.success) {
                        // Update application status
                        await updateDoc(doc(db, "admissions", applicationId), {
                            status: 'approved',
                            approvedAt: new Date(),
                            studentId: result.user.uid
                        });
                        
                        alert(`Application approved successfully!\n\nStudent Account Created:\nEmail: ${studentEmail}\nPassword: ${password}\n\nCredentials have been sent to ${app.email}`);
                        
                        // Refresh applications and statistics
                        loadAdmissionApplications();
                        
                        // Update statistics display
                        const stats = await getSchoolStatistics();
                        document.getElementById('pendingAdmissions').textContent = stats.pendingAdmissionsCount;
                        
                    } else {
                        alert('Error creating student account: ' + result.error);
                    }
                    
                } catch (error) {
                    console.error('Error approving application:', error);
                    alert('Error approving application: ' + error.message);
                }
            }
        };

        // Generate unique roll number
        async function generateRollNumber(standard) {
            try {
                const studentsQuery = query(
                    collection(db, "users"), 
                    where("role", "==", "student"),
                    where("standard", "==", standard)
                );
                const studentsSnapshot = await getDocs(studentsQuery);
                return studentsSnapshot.size + 1;
            } catch (error) {
                console.error("Error generating roll number:", error);
                return 1;
            }
        }

        // Generate random password
        function generatePassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let password = '';
            for (let i = 0; i < 8; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        // Reject admission application
        window.rejectApplication = async function(applicationId) {
            if (confirm('Are you sure you want to reject this application?')) {
                try {
                    await updateDoc(doc(db, "admissions", applicationId), {
                        status: 'rejected',
                        rejectedAt: new Date()
                    });
                    
                    alert('Application rejected!');
                    loadAdmissionApplications();
                    
                    // Update statistics
                    const stats = await getSchoolStatistics();
                    document.getElementById('pendingAdmissions').textContent = stats.pendingAdmissionsCount;
                } catch (error) {
                    alert('Error rejecting application: ' + error.message);
                }
            }
        };

        // View application details
        window.viewApplication = async function(applicationId) {
            try {
                const docSnap = await getDoc(doc(db, "admissions", applicationId));
                if (docSnap.exists()) {
                    const app = docSnap.data();
                    alert(`Application Details:\nName: ${app.studentName}\nClass: ${app.applyingFor}\nCaste: ${app.casteCategory}\nMarks: ${app.entranceMarks}/100\nParent: ${app.parentName}\nPhone: ${app.phone}`);
                }
            } catch (error) {
                alert('Error viewing application: ' + error.message);
            }
        };

        // Filter applications by caste
        window.filterApplications = function() {
            const filter = document.getElementById('casteFilter').value;
            const rows = document.querySelectorAll('#admissionsTable tr');
            
            rows.forEach(row => {
                if (filter === 'all') {
                    row.style.display = '';
                } else {
                    const caste = row.querySelector('td:nth-child(3) span').textContent.toLowerCase();
                    row.style.display = caste === filter ? '' : 'none';
                }
            });
        };

        // UPDATED: Load student notifications - Now fetches from Firestore
        async function loadStudentNotifications(studentId) {
            try {
                const notificationsQuery = query(
                    collection(db, "notifications"),
                    where("studentId", "==", studentId),
                    orderBy("timestamp", "desc"),
                    limit(5)
                );
                const notificationsSnapshot = await getDocs(notificationsQuery);
                
                const notificationsContainer = document.getElementById('studentNotifications');
                notificationsContainer.innerHTML = '';
                
                if (notificationsSnapshot.empty) {
                    notificationsContainer.innerHTML = `
                        <div class="list-group-item">
                            <p class="mb-1 text-muted">No notifications</p>
                        </div>
                    `;
                    return;
                }
                
                notificationsSnapshot.forEach(doc => {
                    const notification = doc.data();
                    const notificationDate = notification.timestamp.toDate();
                    
                    notificationsContainer.innerHTML += `
                        <div class="list-group-item">
                            <h6>${notification.title}</h6>
                            <p class="mb-1">${notification.message}</p>
                            <small class="text-muted">From: ${notification.sentByName || 'Teacher'} • ${notificationDate.toLocaleDateString()}</small>
                        </div>
                    `;
                });
            } catch (error) {
                console.error("Error loading notifications:", error);
            }
        }

        // UPDATED: Save attendance function - Now tracks attendance in days
        window.saveAttendance = async function() {
            const attendanceDate = document.getElementById('attendanceDate').value;
            const standard = document.getElementById('attendanceClass').value;
            const attendanceSelects = document.querySelectorAll('.attendance-select');
            
            if (!attendanceDate || !standard) {
                showNotification('Please select date and class', 'error');
                return;
            }
            
            try {
                // NEW: Save to Realtime Database for real-time updates
                const realtimeAttendance = {};
                
                for (const select of attendanceSelects) {
                    const studentId = select.getAttribute('data-id');
                    const status = select.value;
                    
                    // Save attendance record to Firestore
                    await addDoc(collection(db, "attendance"), {
                        studentId: studentId,
                        date: new Date(attendanceDate),
                        status: status,
                        standard: standard,
                        markedBy: currentUser.uid,
                        markedAt: new Date()
                    });
                    
                    // Update real-time data
                    realtimeAttendance[studentId] = {
                        status: status,
                        timestamp: new Date().toISOString(),
                        markedBy: currentUser.uid
                    };
                    
                    // Update student's attendance days count
                    await updateStudentAttendanceDays(studentId, status);
                }
                
                // Save to Realtime Database
                await saveToRealtimeDB(`attendance/${standard}/${attendanceDate}`, realtimeAttendance);
                
                showNotification('Attendance saved successfully!', 'success');
                const modal = bootstrap.Modal.getInstance(document.getElementById('attendanceModal'));
                modal.hide();
                
            } catch (error) {
                console.error('Error saving attendance:', error);
                showNotification('Error saving attendance. Please try again.', 'error');
            }
        };

        // NEW: Update student attendance days count
        async function updateStudentAttendanceDays(studentId, status) {
            try {
                // Get current student data
                const studentDoc = await getDoc(doc(db, "users", studentId));
                const studentData = studentDoc.data();
                
                let currentAttendanceDays = studentData.attendanceDays || 0;
                
                // Only increment if student is present
                if (status === 'present') {
                    currentAttendanceDays++;
                }
                
                await updateDoc(doc(db, "users", studentId), {
                    attendanceDays: currentAttendanceDays,
                    lastUpdated: new Date()
                });
                
            } catch (error) {
                console.error("Error updating student attendance days:", error);
            }
        }

        // File upload functionality
        function setupFileUpload() {
            const fileUploadContainer = document.getElementById('fileUploadContainer');
            const profilePhotoInput = document.getElementById('profilePhotoInput');
            const previewImage = document.getElementById('previewImage');
            const imagePreview = document.getElementById('imagePreview');
            const uploadPhotoBtn = document.getElementById('uploadPhotoBtn');
            
            // Drag and drop functionality
            fileUploadContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUploadContainer.classList.add('dragover');
            });
            
            fileUploadContainer.addEventListener('dragleave', () => {
                fileUploadContainer.classList.remove('dragover');
            });
            
            fileUploadContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploadContainer.classList.remove('dragover');
                
                if (e.dataTransfer.files.length) {
                    profilePhotoInput.files = e.dataTransfer.files;
                    handleImageSelection();
                }
            });
            
            // File input change
            profilePhotoInput.addEventListener('change', handleImageSelection);
            
            // Upload button click - NOW USES CLOUDINARY
            uploadPhotoBtn.addEventListener('click', uploadProfilePhotoToCloudinary);
            
            function handleImageSelection() {
                const file = profilePhotoInput.files[0];
                if (file) {
                    if (file.type.startsWith('image/')) {
                        selectedFile = file;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            previewImage.src = e.target.result;
                            imagePreview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    } else {
                        alert('Please select an image file.');
                        profilePhotoInput.value = '';
                        selectedFile = null;
                    }
                }
            }
        }

        // Upload profile photo to Cloudinary
        async function uploadProfilePhotoToCloudinary() {
            if (!selectedFile) {
                alert('Please select a photo to upload.');
                return;
            }
            
            if (!currentUser) {
                alert('You must be logged in to upload a photo.');
                return;
            }
            
            try {
                // Show upload progress
                const uploadProgress = document.getElementById('uploadProgress');
                const progressFill = document.getElementById('progressFill');
                const uploadStatus = document.getElementById('uploadStatus');
                
                uploadProgress.style.display = 'block';
                progressFill.style.width = '0%';
                uploadStatus.textContent = 'Uploading...';
                
                // Create form data for upload
                const formData = new FormData();
                formData.append('file', selectedFile);
                formData.append('upload_preset', cloudinaryConfig.uploadPreset);
                formData.append('cloud_name', cloudinaryConfig.cloudName);
                
                // Upload to Cloudinary
                const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/image/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Upload failed');
                }
                
                const data = await response.json();
                
                // Update progress to 100%
                progressFill.style.width = '100%';
                uploadStatus.textContent = 'Upload complete!';
                
                // Update the user's profile in Firestore with Cloudinary URL
                await updateDoc(doc(db, "users", currentUser.uid), {
                    photoURL: data.secure_url,
                    lastUpdated: new Date()
                });
                
                // Update current user data
                currentUserData.photoURL = data.secure_url;
                
                // Close the modal after a short delay
                setTimeout(() => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('imageUploadModal'));
                    modal.hide();
                    
                    // Refresh the dashboard to show the new photo
                    showDashboard(currentUserData.role, currentUserData);
                    
                    showNotification('Profile photo updated successfully!', 'success');
                }, 1000);
                
            } catch (error) {
                console.error('Error uploading photo to Cloudinary:', error);
                document.getElementById('uploadStatus').textContent = 'Upload failed. Please try again.';
                showNotification('Error uploading photo. Please try again.', 'error');
            }
        }

        // Show image upload modal
        window.showImageUploadModal = function() {
            // Reset the form
            document.getElementById('profilePhotoInput').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('uploadProgress').style.display = 'none';
            selectedFile = null;
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('imageUploadModal'));
            modal.show();
        };

        // NEW: Update attendance display for real-time updates
        function updateAttendanceDisplay(attendanceData) {
            // This function would update the attendance display in real-time
            // when changes are detected in the Realtime Database
            console.log('Real-time attendance update:', attendanceData);
            // Implementation would depend on your specific UI requirements
        }

        // Attendance System Functions
        async function loadClassesForAttendance() {
            try {
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const standardsSet = new Set();
                
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    if (userData.standard && userData.role === 'student') {
                        standardsSet.add(userData.standard);
                    }
                });
                
                const classes = Array.from(standardsSet).sort();
                const classSelect = document.getElementById('attendanceClass');
                
                classSelect.innerHTML = '<option value="">-- Select Class --</option>';
                classes.forEach(classItem => {
                    const option = document.createElement('option');
                    option.value = classItem;
                    option.textContent = `Class ${classItem}`;
                    classSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading classes for attendance:', error);
            }
        }

        async function loadStudentsForAttendance(standard) {
            if (!standard) return;
            
            const loading = document.getElementById('attendanceLoading');
            const summary = document.getElementById('attendanceSummary');
            const list = document.getElementById('attendanceList');
            const actions = document.getElementById('attendanceActions');
            const container = document.getElementById('attendanceStudentsContainer');
            
            loading.style.display = 'block';
            summary.style.display = 'none';
            list.style.display = 'none';
            actions.style.display = 'none';
            
            try {
                const q = query(
                    collection(db, "users"), 
                    where("role", "==", "student"), 
                    where("standard", "==", standard)
                );
                const snapshot = await getDocs(q);
                
                attendanceStudents = [];
                snapshot.forEach(doc => {
                    const student = doc.data();
                    student.id = doc.id;
                    attendanceStudents.push(student);
                });
                
                // Sort students by roll number
                attendanceStudents.sort((a, b) => {
                    const rollA = a.rollNo || 9999;
                    const rollB = b.rollNo || 9999;
                    return rollA - rollB;
                });
                
                // Set default status to present
                attendanceStudents.forEach(student => {
                    student.attendanceStatus = 'present';
                });
                
                renderAttendanceStudents();
                
                loading.style.display = 'none';
                summary.style.display = 'grid';
                list.style.display = 'block';
                actions.style.display = 'block';
                
            } catch (error) {
                console.error('Error loading students for attendance:', error);
                loading.style.display = 'none';
                showNotification('Error loading students', 'error');
            }
        }

        function renderAttendanceStudents() {
            const container = document.getElementById('attendanceStudentsContainer');
            container.innerHTML = '';
            
            if (attendanceStudents.length === 0) {
                container.innerHTML = '<div class="attendance-row" style="text-align: center; grid-template-columns: 1fr;">No students found</div>';
                updateAttendanceSummary();
                return;
            }
            
            attendanceStudents.forEach((student, index) => {
                const studentRow = document.createElement('div');
                studentRow.className = 'attendance-row';
                studentRow.innerHTML = `
                    <div>${index + 1}</div>
                    <div><strong>${student.rollNo || 'N/A'}</strong></div>
                    <div>${student.name}</div>
                    <div>
                        <span class="status-badge status-${student.attendanceStatus || 'present'}">
                            ${(student.attendanceStatus || 'present').charAt(0).toUpperCase() + (student.attendanceStatus || 'present').slice(1)}
                        </span>
                    </div>
                    <div>
                        <select class="status-select attendance-select" data-id="${student.id}">
                            <option value="present" ${(student.attendanceStatus || 'present') === 'present' ? 'selected' : ''}>Present</option>
                            <option value="absent" ${(student.attendanceStatus || 'present') === 'absent' ? 'selected' : ''}>Absent</option>
                            <option value="late" ${(student.attendanceStatus || 'present') === 'late' ? 'selected' : ''}>Late</option>
                            <option value="left-early" ${(student.attendanceStatus || 'present') === 'left-early' ? 'selected' : ''}>Left Early</option>
                        </select>
                    </div>
                `;
                container.appendChild(studentRow);
            });
            
            updateAttendanceSummary();
            
            document.querySelectorAll('.attendance-select').forEach(select => {
                select.addEventListener('change', handleAttendanceStatusChange);
            });
        }

        function handleAttendanceStatusChange(e) {
            const studentId = e.target.dataset.id;
            const newStatus = e.target.value;
            
            const studentIndex = attendanceStudents.findIndex(s => s.id === studentId);
            if (studentIndex !== -1) {
                attendanceStudents[studentIndex].attendanceStatus = newStatus;
                
                const studentRow = e.target.closest('.attendance-row');
                const statusBadge = studentRow.querySelector('.status-badge');
                statusBadge.className = `status-badge status-${newStatus}`;
                statusBadge.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
                
                updateAttendanceSummary();
            }
        }

        function updateAttendanceSummary() {
            const present = attendanceStudents.filter(s => (s.attendanceStatus || 'present') === 'present').length;
            const absent = attendanceStudents.filter(s => (s.attendanceStatus || 'present') === 'absent').length;
            const late = attendanceStudents.filter(s => (s.attendanceStatus || 'present') === 'late').length;
            const leftEarly = attendanceStudents.filter(s => (s.attendanceStatus || 'present') === 'left-early').length;
            
            document.getElementById('presentCount').textContent = present;
            document.getElementById('absentCount').textContent = absent;
            document.getElementById('lateCount').textContent = late;
            document.getElementById('leftEarlyCount').textContent = leftEarly;
        }

        function markAllAsPresent() {
            if (attendanceStudents.length === 0) {
                showNotification('No students to mark', 'error');
                return;
            }
            
            attendanceStudents.forEach(student => {
                student.attendanceStatus = 'present';
            });
            
            renderAttendanceStudents();
            showNotification('All students marked as present');
        }

        function markAllAsAbsent() {
            if (attendanceStudents.length === 0) {
                showNotification('No students to mark', 'error');
                return;
            }
            
            attendanceStudents.forEach(student => {
                student.attendanceStatus = 'absent';
            });
            
            renderAttendanceStudents();
            showNotification('All students marked as absent');
        }

        // Utility functions
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                ${message}
            `;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            populateToppers();
            loadEvents();
            setupFileUpload();
            
            const roleButtons = document.querySelectorAll('.role-btn');
            const roleSelection = document.getElementById('roleSelection');
            const loginForm = document.getElementById('loginForm');
            const standardField = document.getElementById('standardField');
            const backToRole = document.getElementById('backToRole');
            const actualLoginForm = document.getElementById('actualLoginForm');
            const admissionForm = document.getElementById('admissionForm');
            const newsletterForm = document.getElementById('newsletterForm');
            
            let selectedRole = '';
            
            roleButtons.forEach(button => {
                button.addEventListener('click', function() {
                    selectedRole = this.getAttribute('data-role');
                    roleSelection.style.display = 'none';
                    loginForm.style.display = 'block';
                    
                    if (selectedRole === 'principal') {
                        standardField.style.display = 'none';
                    } else {
                        standardField.style.display = 'block';
                    }
                });
            });
            
            backToRole.addEventListener('click', function(e) {
                e.preventDefault();
                loginForm.style.display = 'none';
                roleSelection.style.display = 'block';
                selectedRole = '';
                actualLoginForm.reset();
            });
            
            actualLoginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const standard = selectedRole !== 'principal' ? document.getElementById('standard').value : '';
                
                // Authenticate with Firebase
                loginWithFirebase(email, password, selectedRole, standard);
            });
            
            // Admission form submission
            admissionForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Get form values
                const studentName = document.getElementById('studentName').value;
                const applyingFor = document.getElementById('applyingFor').value;
                
                // Save to Firebase
                addDoc(collection(db, 'admissions'), {
                    studentName: studentName,
                    dob: document.getElementById('dob').value,
                    gender: document.getElementById('gender').value,
                    applyingFor: applyingFor,
                    previousSchool: document.getElementById('previousSchool').value,
                    casteCategory: document.getElementById('casteCategory').value,
                    entranceMarks: parseInt(document.getElementById('entranceMarks').value),
                    parentName: document.getElementById('parentName').value,
                    parentOccupation: document.getElementById('parentOccupation').value,
                    phone: document.getElementById('phone').value,
                    email: document.getElementById('email').value,
                    address: document.getElementById('address').value,
                    status: 'pending',
                    timestamp: new Date()
                }).then(() => {
                    showNotification(`Thank you ${studentName}! Your application for Class ${applyingFor} has been submitted successfully. We will contact you soon.`, 'success');
                    
                    // Close modal
                    const admissionModal = bootstrap.Modal.getInstance(document.getElementById('admissionModal'));
                    admissionModal.hide();
                    
                    // Reset form
                    admissionForm.reset();
                }).catch((error) => {
                    console.error("Error adding document: ", error);
                    showNotification("There was an error submitting your application. Please try again.", 'error');
                });
            });
            
            // Newsletter form submission
            newsletterForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const email = this.querySelector('input[type="email"]').value;
                
                // Save to Firebase
                addDoc(collection(db, 'newsletter'), {
                    email: email,
                    timestamp: new Date()
                }).then(() => {
                    showNotification('Thank you for subscribing to our newsletter!', 'success');
                    this.reset();
                }).catch((error) => {
                    console.error("Error adding document: ", error);
                    showNotification("There was an error with your subscription. Please try again.", 'error');
                });
            });

            // Set up authentication state observer
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    console.log("User is signed in:", user.email);
                } else {
                    currentUser = null;
                    currentUserData = null;
                    console.log("User is signed out");
                }
            });

            // Attendance system event listeners
            document.getElementById('attendanceClass').addEventListener('change', function() {
                const standard = this.value;
                if (standard) {
                    loadStudentsForAttendance(standard);
                }
            });
            
            document.getElementById('markAllPresent').addEventListener('click', markAllAsPresent);
            document.getElementById('markAllAbsent').addEventListener('click', markAllAsAbsent);
            document.getElementById('saveAttendance').addEventListener('click', window.saveAttendance);
            document.getElementById('closeAttendance').addEventListener('click', function() {
                const modal = bootstrap.Modal.getInstance(document.getElementById('attendanceModal'));
                modal.hide();
            });
        });

        // Navbar scroll effect
        window.addEventListener('scroll', function() {
            const navbar = document.querySelector('.navbar');
            if (window.scrollY > 50) {
                navbar.classList.add('scrolled');
            } else {
                navbar.classList.remove('scrolled');
            }
        });

        // Smooth scrolling for navigation links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });
    </script>
</body>
</html>
